<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calendario Worship PDC</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f9f9fb;color:#333;margin:15px;padding-bottom:70px}
h1{text-align:center;color:#4A90E2;font-weight:700;margin-bottom:10px;text-shadow:1px 1px 2px rgba(74,144,226,0.5)}
.hidden{display:none}
form,.calendar-block{width:100%;max-width:1100px;margin:0 auto 15px auto}
table{width:100%;border-collapse:collapse;margin-top:5px;table-layout:fixed}
table th:nth-child(1),table td:nth-child(1){width:14%}
table th:nth-child(2),table td:nth-child(2){width:14%}
table th:nth-child(3),table td:nth-child(3){width:18%}
table th:nth-child(4),table td:nth-child(4){width:10%}
table th:nth-child(5),table td:nth-child(5){width:20%}
table th:nth-child(6),table td:nth-child(6){width:10%}
table th:nth-child(7),table td:nth-child(7){width:8%}
th,td{border:1px solid #ccc;padding:5px 6px;text-align:center;vertical-align:middle;font-size:0.9em}
th{background:linear-gradient(135deg,#4A90E2,#357ABD);color:white;font-weight:600}
input[type=text],input[type=url],input[type=date],input[type=password],input[type=file]{width:95%;padding:4px 5px;border-radius:4px;border:1px solid #bbb;font-size:0.85em;box-sizing:border-box}
button{background-color:#4A90E2;border:none;color:white;padding:5px 10px;font-size:0.85em;font-weight:600;border-radius:5px;cursor:pointer;transition:background-color 0.3s ease}
button:hover{background-color:#357ABD}
.assign-green{background-color:#28a745;color:white;font-weight:600;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;transition:background-color 0.3s ease;display:block;margin:5px auto}
.assign-green:hover{background-color:#218838}
iframe{width:100%;max-width:160px;height:90px;display:block;margin:0 auto;border-radius:6px}
a{word-break:break-word;display:inline-block;font-size:0.8em;color:#274D87;text-decoration:none}
a:hover{text-decoration:underline}
.actions button{margin:2px 4px;font-size:0.75em;padding:3px 6px;border-radius:4px}
.actions .edit{background-color:#F0AD4E}
.calendar-block{border:2px solid #4A90E2;border-radius:8px;background:#fff;margin-bottom:15px;box-shadow:0 0 8px rgba(74,144,226,0.1);padding:0;overflow:hidden}
.calendar-date{background:#4A90E2;color:white;padding:5px;border-radius:8px 8px 0 0;font-weight:600;text-align:center;font-size:1em}
#logoutBtn{position:absolute;top:15px;right:25px}
#assignModal,#searchModal,#toneModal,#editModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:10010;padding:20px;box-sizing:border-box}
#assignContent,#searchContent,#toneContent,#editContent{background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,0.25);box-sizing:border-box;z-index:10020}
#assignContent{width:320px;max-height:80vh;overflow-y:auto}
#searchContent{width:600px;max-height:80vh;overflow-y:auto}
#toneContent{width:500px;max-height:500px;overflow-y:auto}
#editContent{width:420px;max-width:100%;max-height:85vh;display:flex;flex-direction:column;gap:8px;padding:12px 14px}
#assignContent h3,#searchContent h3,#toneContent h3,#editContent h3{color:#4A90E2;text-align:center;margin-bottom:8px}
.assign-item{margin:6px 0;display:flex;flex-direction:column}
.assign-item label{font-weight:bold;margin-bottom:3px;font-size:0.85em}
.assign-item select{padding:4px;border:1px solid #ccc;border-radius:5px;font-size:0.85em;width:100%;box-sizing:border-box}
td:nth-child(5){white-space:pre-line;text-align:left;font-size:0.9em}
.video-result{display:flex;align-items:flex-start;gap:15px;border-bottom:1px solid #ddd;padding:15px 10px;transition:background 0.2s;background:#fff}
.video-result:hover{background:#f8f9fa}
.video-result iframe{width:160px;height:90px;flex-shrink:0;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.15)}
.video-result .info{flex:1;text-align:left;display:flex;flex-direction:column;gap:6px}
.video-result .info .songname{color:#4A90E2;font-weight:700;font-size:1.1em;margin:0}
.video-result .info .date{color:#333;font-weight:600;font-size:0.9em;margin:0}
.video-result .info .link{color:#666;font-size:0.8em;word-break:break-all;margin:0;line-height:1.4}
.video-result button{background:#28a745;padding:8px 20px;font-size:0.85em;flex-shrink:0;border-radius:6px;font-weight:600;align-self:flex-start}
.tone-btn{margin-left:4px;padding:4px 7px;font-size:0.9em;border-radius:6px;background:#4A90E2;color:#fff;cursor:pointer;border:none}
.tone-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin:12px 0}
.tone-option{display:flex;align-items:center;justify-content:center;padding:10px;background:#f0f0f0;border-radius:5px;cursor:pointer;font-weight:600;font-size:0.9em;transition:all 0.2s}
.tone-option:hover{background:#4A90E2;color:#fff;transform:scale(1.05)}
.edit-body{overflow:auto;padding-right:6px}
.edit-footer{display:flex;gap:10px;justify-content:center;align-items:center;padding-top:8px;border-top:1px solid #eee;margin-top:6px;background:transparent;flex-shrink:0}
.edit-footer button{min-width:120px}
#accessOverlay{position:fixed;inset:0;background:radial-gradient(circle at center,rgba(0,0,0,0.9) 0%,rgba(0,0,0,0.85) 80%);display:flex;align-items:center;justify-content:center;z-index:9999;animation:pulseBg 5s infinite ease-in-out}
@keyframes pulseBg{0%,100%{background:radial-gradient(circle at center,rgba(0,0,0,0.9) 0%,rgba(0,0,0,0.85) 80%)}50%{background:radial-gradient(circle at center,rgba(0,0,0,0.95) 0%,rgba(0,0,0,0.9) 80%)}}
.overlay-card{width:520px;border-radius:20px;padding:32px 30px;background:linear-gradient(180deg,rgba(16,16,20,0.75),rgba(8,8,10,0.6));border:1px solid rgba(255,255,255,0.08);box-shadow:0 10px 40px rgba(0,0,0,0.7);color:#fff;text-align:center;position:relative;overflow:hidden;backdrop-filter:blur(10px) saturate(1.1)}
.overlay-card::before{content:"";position:absolute;inset:-30% -10% auto -10%;height:220%;background:radial-gradient(40% 30% at 10% 20%,rgba(255,255,255,0.03),transparent 15%),radial-gradient(30% 25% at 80% 80%,rgba(255,255,255,0.02),transparent 20%);animation:mistMove 14s linear infinite;pointer-events:none}
@keyframes mistMove{0%{transform:translateY(0) scale(1.05)}50%{transform:translateY(-6%) scale(1.07)}100%{transform:translateY(0) scale(1.05)}}
.overlay-card .logo{width:210px;margin:10px auto 16px auto;filter:drop-shadow(0 8px 25px rgba(74,144,226,0.25));animation:logoPulse 3s infinite ease-in-out}
@keyframes logoPulse{0%,100%{transform:scale(1);filter:drop-shadow(0 8px 25px rgba(74,144,226,0.25))}50%{transform:scale(1.06);filter:drop-shadow(0 10px 35px rgba(255,215,0,0.35))}}
.overlay-card h2{margin:8px 0 20px 0;color:#FFD700;font-weight:700;font-size:1.4em;text-shadow:0 2px 15px rgba(255,215,0,0.2)}
.choiceBtns{display:flex;gap:12px;justify-content:center;flex-wrap:wrap}
.choiceBtns button{min-width:150px;padding:10px 16px;border-radius:10px;font-size:1rem;background-color:#4A90E2;color:white;border:none;cursor:pointer;font-weight:600;transition:background-color 0.3s ease,transform 0.2s ease}
.choiceBtns button:hover{background-color:#357ABD;transform:scale(1.03)}
.formBox{margin-top:16px;display:none;flex-direction:column;align-items:center;gap:8px}
.formBox input{min-width:240px;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:#fff;text-align:center}
.formBox button{padding:8px 12px;border-radius:8px;background-color:#4A90E2;color:#fff;border:none;cursor:pointer;transition:background-color 0.3s ease}
.formBox button:hover{background-color:#357ABD}
.smallMsg{margin-top:10px;color:#ff8b8b;font-weight:600;min-height:18px}
.closeOverlay{position:absolute;top:10px;right:12px;background:transparent;border:none;color:rgba(255,255,255,0.5);font-size:1.1rem;padding:6px;border-radius:8px;cursor:pointer}
.closeOverlay:hover{color:#fff;background:rgba(255,255,255,0.06)}
body.overlayLocked{overflow:hidden;height:100vh}
.table-container{width:100%;overflow:auto;-webkit-overflow-scrolling:touch}
.video-thumb{display:inline-block;width:160px;height:90px;border-radius:6px;overflow:hidden;background:#000}
.video-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.file-uploaded{display:none;color:#28a745;font-weight:600;font-size:0.85em;padding:5px}
.search-filter{width:100%;padding:10px;margin-bottom:15px;border:2px solid #4A90E2;border-radius:8px;font-size:0.95em;box-sizing:border-box}
.search-filter:focus{outline:none;border-color:#357ABD;box-shadow:0 0 8px rgba(74,144,226,0.3)}
#footer{position:fixed;bottom:0;left:0;width:100%;background:#2c3e50;color:#fff;text-align:center;padding:12px 0;font-size:0.85em;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:1000}
#footer a{color:#fff;text-decoration:none;transition:color 0.3s;font-size:0.85em}
#footer a:hover{color:#4A90E2}
#loginFooter{position:fixed;bottom:0;left:0;width:100%;text-align:center;padding:12px 0;font-size:0.85em;z-index:10000;color:#fff;background:transparent}
#loginFooter a{color:#fff;text-decoration:none;transition:color 0.3s;font-size:0.85em}
#loginFooter a:hover{color:#4A90E2}
#clearListBtn{background-color:#D9534F;color:white;font-weight:600;padding:12px 24px;font-size:1em;border-radius:8px;cursor:pointer;transition:background-color 0.3s ease;border:none;display:block;margin:20px auto;box-shadow:0 2px 8px rgba(217,83,79,0.3)}
#clearListBtn:hover{background-color:#c9302c;box-shadow:0 4px 12px rgba(217,83,79,0.4)}
#accessOverlay.fadeOut{animation:fadeOut 1.4s ease forwards}
@keyframes fadeOut{from{opacity:1}to{opacity:0;visibility:hidden}}
.same-musicians-btn{width:100%;background:#FF9800;color:white;margin:12px 0 12px 0;padding:10px;border-radius:5px;cursor:pointer;font-weight:600;border:none;transition:background-color 0.3s;font-size:0.9em}
.same-musicians-btn:hover{background-color:#E68900}
#assignFieldsContainer{max-height:35vh;overflow-y:auto;margin-bottom:10px;padding-right:5px}
@media (max-width:520px){
  table{min-width:700px;table-layout:auto}
  th,td{padding:8px;border:1px solid #ddd;font-size:0.92em}
  .assign-green{width:100%;box-sizing:border-box}
  .overlay-card{padding:18px;width:90%;max-width:520px}
  body.overlayLocked h1{margin-top:48px}
  #footer,#loginFooter{font-size:0.75em;padding:10px 5px}
  .tone-grid{grid-template-columns:repeat(3,1fr);gap:6px}
  #logoutBtn{top:75px!important;right:15px!important;padding:8px 12px;font-size:0.8em;z-index:500}
}
@media (min-width:521px){
  .video-thumb{display:none!important}
}
</style>
<script>
  UPLOADCARE_PUBLIC_KEY = '30ff0475e669c38ca029';
  UPLOADCARE_LOCALE = 'es';
</script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
</head>
<body class="overlayLocked">
<h1>Calendario Worship PDC</h1>
<button id="logoutBtn" class="hidden">Cerrar sesión</button>

<div id="accessOverlay">
  <div class="overlay-card">
    <button class="closeOverlay" id="overlayClose">&times;</button>
    <img src="imagen1.jpg" alt="Logo PDC" class="logo">
    <h2>Bienvenido a Worship PDC</h2>
    <div class="choiceBtns" id="loginChoices">
      <button type="button" id="visitorChoice">Entrar como Visitante</button>
      <button type="button" id="adminChoice">Login Admin</button>
    </div>
    <div id="visitorBox" class="formBox">
      <input id="visitorPass" type="password" placeholder="Contraseña visitante">
      <div class="actions">
        <button type="button" id="visitorSubmit">Entrar</button>
        <button type="button" id="visitorCancel">Volver</button>
      </div>
    </div>
    <div id="adminBox" class="formBox">
      <input id="adminUser" type="text" placeholder="Usuario">
      <input id="adminPass" type="password" placeholder="Contraseña">
      <div class="actions">
        <button type="button" id="adminSubmit">Entrar</button>
        <button type="button" id="adminCancel">Volver</button>
      </div>
    </div>
    <div id="overlayError" class="smallMsg"></div>
  </div>
  <div id="loginFooter">
    Desarrollado por Moisés Morales | Worship PDC © 2025
  </div>
</div>

<div id="mainContent" class="hidden">
  <form id="lineForm" class="hidden">
    <div class="table-container">
      <table>
        <tr>
          <th>Video YouTube</th><th>Nombre Canción</th><th>Cifrado PDF</th><th>Tono</th><th>Músicos</th><th>Fecha</th><th>Acción</th>
        </tr>
        <tr>
          <td><div style="display:flex;align-items:center;gap:5px"><input type="url" id="videoURL" placeholder="https://..."><button type="button" id="searchVideoBtn">Buscar</button></div></td>
          <td><input type="text" id="songName" placeholder="Nombre de la canción"></td>
          <td>
            <button type="button" id="uploadBtn" style="width:95%;background:#28a745;padding:8px">📤 Subir PDF</button>
            <div id="fileUploaded" class="file-uploaded"></div>
          </td>
          <td><div style="display:flex;align-items:center;gap:5px;justify-content:center"><input type="text" id="chords" placeholder="G - D - Em"><button type="button" id="toneBtn" class="tone-btn">🎵</button></div></td>
          <td><button type="button" id="assignBtn" class="assign-green">Asignar músicos</button></td>
          <td><input type="date" id="customDate"></td>
          <td><button type="button" id="addLine">Agregar</button></td>
        </tr>
      </table>
    </div>
  </form>
  <h2 style="text-align:center;color:#4A90E2">Lista multimedia</h2>
  <div id="calendarContainer"></div>
  <button id="clearListBtn" class="hidden">🗑️ Limpiar Lista</button>
</div>

<div id="toneModal"><div id="toneContent"><h3>Seleccionar Tono</h3><div id="toneOptions" class="tone-grid"></div><div style="text-align:center;margin-top:12px"><button type="button" id="closeTone">Cerrar</button></div></div></div>
<div id="assignModal"><div id="assignContent"><h3>Asignar Músicos</h3><div id="assignFieldsContainer"><div id="assignFields"></div></div><button type="button" id="sameMusicianBtn" class="same-musicians-btn" style="display:none;">👥 Mismos Músicos</button><div style="text-align:center;margin-top:10px"><button type="button" id="saveAssign">Guardar</button><button type="button" id="closeAssign">Cerrar</button></div></div></div>
<div id="searchModal">
  <div id="searchContent">
    <h3>Buscar Video</h3>
    <input type="text" id="searchFilter" class="search-filter" placeholder="🔍 Buscar por nombre, fecha o URL...">
    <div id="videoList"></div>
    <div style="text-align:center;margin-top:10px"><button type="button" id="closeSearch">Cerrar</button></div>
  </div>
</div>
<div id="editModal"><div id="editContent"><h3>Modificar Canción</h3><div class="edit-body"><label>Video YouTube</label><input type="url" id="editVideo"><label>Nombre Canción</label><input type="text" id="editSongName"><label>Cifrado PDF</label><button type="button" id="editUploadBtn" style="width:100%;background:#28a745;padding:8px;margin:5px 0">📤 Cambiar PDF</button><div id="editFileUploaded" class="file-uploaded"></div><label>Tono</label><input type="text" id="editChords"><div id="editAssignFields"></div><label>Fecha</label><input type="date" id="editDate"></div><div class="edit-footer"><button type="button" id="saveEdit">Guardar</button><button type="button" id="cancelEdit">Cancelar</button></div></div></div>

<div id="footer">
  Desarrollado por Moisés Morales | Worship PDC © 2025
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDhWpUt9cfxa21T8ijfUCIJuApWBBaBUJQ",
  authDomain: "worship-pdc.firebaseapp.com",
  projectId: "worship-pdc",
  storageBucket: "worship-pdc.appspot.com",
  messagingSenderId: "132891019857",
  appId: "1:132891019857:web:3d72cfe959a8d14cdf4670"
});

const db = getFirestore(app);
const auth = getAuth(app);

const ADMIN_EMAIL = "adminpdc@worship.com";
const VISITOR_EMAIL = "visitante@worship.com";

let loggedIn = false;
let visitorLogged = false;
let currentUser = null;
window.uploadedFileData = null;
window.editUploadedFileData = null;
let allSongs = [];

const accessOverlay = document.getElementById("accessOverlay");
const mainContent = document.getElementById("mainContent");
const lineForm = document.getElementById("lineForm");
const logoutBtn = document.getElementById("logoutBtn");
const clearListBtn = document.getElementById("clearListBtn");
  // asegurar que el botón esté oculto por defecto
  clearListBtn.style.display = "none";

function extractYouTubeID(url) {
  if (!url) return null;
  const m = url.match(/(?:v=|youtu\.be\/|\/embed\/)([^&?/]+)/);
  return m ? m[1] : null;
}

function showOverlay() {
  accessOverlay.style.display = "flex";
  accessOverlay.classList.remove("fadeOut");
  document.body.classList.add("overlayLocked");
  document.getElementById("overlayError").textContent = "";
  document.getElementById("visitorBox").style.display = "none";
  document.getElementById("adminBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
}

function hideOverlay() {
  accessOverlay.classList.add("fadeOut");
  document.body.classList.remove("overlayLocked");
  setTimeout(() => {
    accessOverlay.style.display = "none";
  }, 1400);
}

function enterAsVisitor() {
  visitorLogged = true;
  loggedIn = false;
  hideOverlay();
  mainContent.classList.remove("hidden");
  lineForm.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  clearListBtn.style.display = "none";
  renderSongs();
}

function enterAsAdmin() {
  visitorLogged = false;
  loggedIn = true;
  hideOverlay();
  mainContent.classList.remove("hidden");
  lineForm.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  clearListBtn.style.display = "block";
  renderSongs();
}

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    if (user.email === ADMIN_EMAIL) {
      enterAsAdmin();
    } else if (user.email === VISITOR_EMAIL) {
      enterAsVisitor();
    }
  } else {
    currentUser = null;
    loggedIn = false;
    visitorLogged = false;
    if (!accessOverlay.style.display || accessOverlay.style.display === "none") {
      showOverlay();
    }
  }
});

document.getElementById("visitorChoice").onclick = () => {
  document.getElementById("loginChoices").style.display = "none";
  document.getElementById("visitorBox").style.display = "flex";
};

document.getElementById("adminChoice").onclick = () => {
  document.getElementById("loginChoices").style.display = "none";
  document.getElementById("adminBox").style.display = "flex";
};

document.getElementById("visitorCancel").onclick = () => {
  document.getElementById("visitorBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
  document.getElementById("visitorPass").value = "";
};

document.getElementById("adminCancel").onclick = () => {
  document.getElementById("adminBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
  document.getElementById("adminUser").value = "";
  document.getElementById("adminPass").value = "";
};

document.getElementById("overlayClose").onclick = () => {
  document.getElementById("visitorBox").style.display = "none";
  document.getElementById("adminBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
  document.getElementById("visitorPass").value = "";
  document.getElementById("adminUser").value = "";
  document.getElementById("adminPass").value = "";
};

document.getElementById("visitorSubmit").onclick = async () => {
  const pass = document.getElementById("visitorPass").value.trim();
  if (!pass) {
    document.getElementById("overlayError").textContent = "Ingresa la contraseña de visitante.";
    return;
  }
  
  try {
    document.getElementById("overlayError").textContent = "Autenticando...";
    await signInWithEmailAndPassword(auth, VISITOR_EMAIL, pass);
  } catch (error) {
    console.error("Error login visitante:", error);
    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
      document.getElementById("overlayError").textContent = "Contraseña incorrecta.";
    } else {
      document.getElementById("overlayError").textContent = "Error al iniciar sesión.";
    }
  }
};

document.getElementById("adminSubmit").onclick = async () => {
  const user = document.getElementById("adminUser").value.trim();
  const pass = document.getElementById("adminPass").value.trim();
  
  if (!user || !pass) {
    document.getElementById("overlayError").textContent = "Ingresa usuario y contraseña.";
    return;
  }
  
  if (user.toUpperCase() !== "ADMINPDC") {
    document.getElementById("overlayError").textContent = "Usuario incorrecto.";
    return;
  }
  
  try {
    document.getElementById("overlayError").textContent = "Autenticando...";
    await signInWithEmailAndPassword(auth, ADMIN_EMAIL, pass);
  } catch (error) {
    console.error("Error login admin:", error);
    if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
      document.getElementById("overlayError").textContent = "Credenciales incorrectas.";
    } else {
      document.getElementById("overlayError").textContent = "Error al iniciar sesión.";
    }
  }
};

logoutBtn.onclick = async () => {
  try {
    await signOut(auth);
    loggedIn = false;
    visitorLogged = false;
    currentUser = null;
    mainContent.classList.add("hidden");
    lineForm.classList.add("hidden");
    logoutBtn.classList.add("hidden");
    clearListBtn.style.display = "none";
    showOverlay();
  } catch (error) {
    console.error("Error al cerrar sesión:", error);
    alert("Error al cerrar sesión");
  }
};

clearListBtn.onclick = () => {
  const confirmModal = document.createElement("div");
  confirmModal.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:20000;";
  
  const confirmCard = document.createElement("div");
  confirmCard.style.cssText = "background:#fff;padding:25px;border-radius:10px;box-shadow:0 0 20px rgba(0,0,0,0.3);text-align:center;max-width:350px;width:90%;";
  
  const title = document.createElement("h3");
  title.textContent = "Confirmación";
  title.style.cssText = "color:#4A90E2;margin-bottom:15px;font-size:1.1em;margin-top:0;";
  
  const message = document.createElement("p");
  message.textContent = "¿Confirmas que deseas Eliminar la Lista multimedia?";
  message.style.cssText = "color:#333;margin-bottom:20px;font-size:0.95em;line-height:1.5;";
  
  const btnContainer = document.createElement("div");
  btnContainer.style.cssText = "display:flex;gap:10px;justify-content:center;flex-wrap:wrap;";
  
  const btnSi = document.createElement("button");
  btnSi.textContent = "Sí";
  btnSi.style.cssText = "background:#28a745;color:#fff;padding:10px 25px;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:0.9em;transition:background 0.3s;";
  btnSi.onmouseover = () => btnSi.style.background = "#218838";
  btnSi.onmouseout = () => btnSi.style.background = "#28a745";
  btnSi.onclick = () => {
    document.getElementById("calendarContainer").innerHTML = "";
    document.body.removeChild(confirmModal);
    alert("✅ Lista multimedia eliminada.");
  };
  
  const btnNo = document.createElement("button");
  btnNo.textContent = "No";
  btnNo.style.cssText = "background:#D9534F;color:#fff;padding:10px 25px;border:none;border-radius:5px;cursor:pointer;font-weight:600;font-size:0.9em;transition:background 0.3s;";
  btnNo.onmouseover = () => btnNo.style.background = "#c9302c";
  btnNo.onmouseout = () => btnNo.style.background = "#D9534F";
  btnNo.onclick = () => {
    document.body.removeChild(confirmModal);
  };
  
  btnContainer.appendChild(btnSi);
  btnContainer.appendChild(btnNo);
  
  confirmCard.appendChild(title);
  confirmCard.appendChild(message);
  confirmCard.appendChild(btnContainer);
  
  confirmModal.appendChild(confirmCard);
  document.body.appendChild(confirmModal);
};

const instruments = ["BATERIA","PIANO","GUITARRA ACUSTICA","GUITARRA ELECTRICA","VOZ 1","VOZ 2","VOZ 3","VOZ LIDER","BAJO"];
const names = ["Rafael","Moises","Ronald","Nelson","Josue","Sebastian","Jose","Nayuris","Gabriela","Daniela","Carolina","Adriana"];
let selectedMusicians = {};
let lastDateMusicians = {};
let usingSameMusicians = false;

const assignBtn = document.getElementById("assignBtn");
const assignModal = document.getElementById("assignModal");
const assignFields = document.getElementById("assignFields");
const sameMusicianBtn = document.getElementById("sameMusicianBtn");

function openAssignModal() {
  assignFields.innerHTML = "";
  instruments.forEach(instr => {
    const div = document.createElement("div");
    div.classList.add("assign-item");
    div.innerHTML = `<label>${instr}:</label>
      <select id="sel-${instr.replace(/\s+/g,'_')}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}" ${selectedMusicians[instr] && selectedMusicians[instr] !== true ? (selectedMusicians[instr]===n?'selected':'') : ''}>${n}</option>`).join('')}
      </select>`;
    assignFields.appendChild(div);
  });
  
  const selectedDate = document.getElementById("customDate").value;
  if (selectedDate && lastDateMusicians[selectedDate] && Object.keys(lastDateMusicians[selectedDate]).length > 0) {
    sameMusicianBtn.style.display = "block";
  } else {
    sameMusicianBtn.style.display = "none";
  }
  
  assignModal.style.display = "flex";
}

assignBtn.onclick = () => {
  if (!loggedIn) return alert("Debes iniciar sesión");
  openAssignModal();
};

sameMusicianBtn.onclick = () => {
  const selectedDate = document.getElementById("customDate").value;
  
  if (!selectedDate || !lastDateMusicians[selectedDate]) {
    alert("No hay asignaciones previas para esta fecha.");
    return;
  }
  
  usingSameMusicians = true;
  
  instruments.forEach(instr => {
    const sel = document.getElementById(`sel-${instr.replace(/\s+/g,'_')}`);
    if (sel) {
      sel.disabled = true;
      sel.style.opacity = "0.6";
      sel.style.cursor = "not-allowed";
    }
  });
  
  alert("✅ Mismos músicos seleccionados. Los campos están deshabilitados.");
};

document.getElementById("closeAssign").onclick = () => {
  assignModal.style.display = "none";
  usingSameMusicians = false;
  instruments.forEach(instr => {
    const sel = document.getElementById(`sel-${instr.replace(/\s+/g,'_')}`);
    if (sel) {
      sel.disabled = false;
      sel.style.opacity = "1";
      sel.style.cursor = "pointer";
    }
  });
};

document.getElementById("saveAssign").onclick = () => {
  const selectedDate = document.getElementById("customDate").value;
  
  if (usingSameMusicians) {
    selectedMusicians = { __sameMusicians: true };
  } else {
    selectedMusicians = {};
    instruments.forEach(instr=>{
      const sel = document.getElementById(`sel-${instr.replace(/\s+/g,'_')}`);
      if (sel && sel.value) {
        selectedMusicians[instr] = sel.value;
      }
    });
    
    if (selectedDate && Object.keys(selectedMusicians).length > 0) {
      lastDateMusicians[selectedDate] = {...selectedMusicians};
    }
  }
  
  usingSameMusicians = false;
  assignModal.style.display = "none";
  
  instruments.forEach(instr => {
    const sel = document.getElementById(`sel-${instr.replace(/\s+/g,'_')}`);
    if (sel) {
      sel.disabled = false;
      sel.style.opacity = "1";
      sel.style.cursor = "pointer";
    }
  });
  
  alert("✅ Asignaciones guardadas correctamente.");
};

const toneBtn = document.getElementById("toneBtn");
const toneModal = document.getElementById("toneModal");
const toneOptions = document.getElementById("toneOptions");
const chordsInput = document.getElementById("chords");
const baseNotes = ["C","C#","Db","D","D#","Eb","E","F","F#","Gb","G","G#","Ab","A","A#","Bb","B"];

function buildToneOptions() {
  toneOptions.innerHTML = "";
  baseNotes.forEach(n => {
    const maj = document.createElement("div");
    maj.className = "tone-option";
    maj.textContent = `${n} mayor`;
    maj.onclick = () => {
      chordsInput.value = maj.textContent;
      toneModal.style.display = "none";
    };
    toneOptions.appendChild(maj);
    
    const min = document.createElement("div");
    min.className = "tone-option";
    min.textContent = `${n} menor`;
    min.onclick = () => {
      chordsInput.value = min.textContent;
      toneModal.style.display = "none";
    };
    toneOptions.appendChild(min);
  });
}

toneBtn.onclick = () => {
  buildToneOptions();
  toneModal.style.display = "flex";
};

document.getElementById("closeTone").onclick = () => {
  toneModal.style.display = "none";
};

const searchVideoBtn = document.getElementById("searchVideoBtn");
const searchModal = document.getElementById("searchModal");
const videoList = document.getElementById("videoList");
const searchFilter = document.getElementById("searchFilter");

function displayFilteredSongs(songs) {
  videoList.innerHTML = "";
  if (songs.length === 0) {
    videoList.innerHTML = "<p style='text-align:center;color:#666;padding:20px;'>No se encontraron canciones.</p>";
    return;
  }
  
  songs.forEach(item => {
    const song = item.data;
    const idv = extractYouTubeID(song.video);
    
    const div = document.createElement("div");
    div.classList.add("video-result");
    
    if (idv) {
      const iframeContainer = document.createElement("div");
      iframeContainer.innerHTML = `<iframe src='https://www.youtube.com/embed/${idv}' frameborder='0' allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture' allowfullscreen></iframe>`;
      div.appendChild(iframeContainer);
    }
    
    const infoDiv = document.createElement("div");
    infoDiv.className = "info";
    
    const nameP = document.createElement("p");
    nameP.className = "songname";
    nameP.textContent = song.songName || '⚠️ Sin nombre';
    
    const dateP = document.createElement("p");
    dateP.className = "date";
    dateP.textContent = song.date || 'Sin fecha';
    
    const linkP = document.createElement("p");
    linkP.className = "link";
    linkP.textContent = song.video || 'Sin video';
    
    infoDiv.appendChild(nameP);
    infoDiv.appendChild(dateP);
    infoDiv.appendChild(linkP);
    
    div.appendChild(infoDiv);
    
    const selBtn = document.createElement("button");
    selBtn.type = "button";
    selBtn.textContent = "Seleccionar";
    selBtn.onclick = () => {
      document.getElementById("videoURL").value = song.video || "";
      document.getElementById("songName").value = song.songName || "";
      searchModal.style.display = "none";
      searchFilter.value = "";
    };
    div.appendChild(selBtn);
    
    videoList.appendChild(div);
  });
}

searchFilter.addEventListener('input', (e) => {
  const query = e.target.value.toLowerCase().trim();
  if (!query) {
    displayFilteredSongs(allSongs);
    return;
  }
  
  const filtered = allSongs.filter(item => {
    const song = item.data;
    const songName = (song.songName || '').toLowerCase();
    const date = (song.date || '').toLowerCase();
    const video = (song.video || '').toLowerCase();
    const chords = (song.chords || '').toLowerCase();
    
    return songName.includes(query) || 
           date.includes(query) || 
           video.includes(query) || 
           chords.includes(query);
  });
  
  displayFilteredSongs(filtered);
});

searchVideoBtn.onclick = async () => {
  searchModal.style.display = "flex";
  videoList.innerHTML = "<p style='text-align:center;'>Cargando canciones...</p>";
  searchFilter.value = "";
  
  try {
    const snap = await getDocs(collection(db, "songs"));
    allSongs = [];
    
    snap.forEach(docSnap => {
      const song = docSnap.data();
      allSongs.push({ id: docSnap.id, data: song });
    });
    
    allSongs.sort((a, b) => {
      const dateA = a.data.date || '';
      const dateB = b.data.date || '';
      return dateB.localeCompare(dateA);
    });
    
    displayFilteredSongs(allSongs);
    
  } catch (err) {
    console.error(err);
    videoList.innerHTML = "<p style='text-align:center;color:#D9534F;'>Error cargando canciones</p>";
  }
};

document.getElementById("closeSearch").onclick = () => {
  searchModal.style.display = "none";
  searchFilter.value = "";
};

const editModal = document.getElementById("editModal");
const editSongName = document.getElementById("editSongName");
const editVideo = document.getElementById("editVideo");
const editChords = document.getElementById("editChords");
const editAssignFields = document.getElementById("editAssignFields");
const editDate = document.getElementById("editDate");

let currentEditId = null;
let currentEditSong = null;

function buildEditAssignFields(existingMusicos = {}) {
  editAssignFields.innerHTML = "<h4 style='text-align:center;margin:8px 0 6px 0;color:#4A90E2;'>Músicos</h4>";
  instruments.forEach(instr => {
    const div = document.createElement("div");
    div.classList.add("assign-item");
    const selId = `editsel-${instr.replace(/\s+/g,'_')}`;
    div.innerHTML = `<label style="font-weight:bold;margin-bottom:3px;">${instr}:</label>
      <select id="${selId}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}" ${existingMusicos[instr]===n?'selected':''}>${n}</option>`).join('')}
      </select>`;
    editAssignFields.appendChild(div);
  });
}

document.getElementById("cancelEdit").onclick = () => {
  editModal.style.display = "none";
  currentEditId = null;
  currentEditSong = null;
  window.editUploadedFileData = null;
  document.getElementById('editFileUploaded').style.display = 'none';
};

editModal.addEventListener('click', (e) => {
  if (e.target === editModal) {
    editModal.style.display = 'none';
    currentEditId = null;
    currentEditSong = null;
    window.editUploadedFileData = null;
    document.getElementById('editFileUploaded').style.display = 'none';
  }
});

window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (editModal.style.display === 'flex') {
      editModal.style.display = 'none';
      currentEditId = null;
      currentEditSong = null;
      window.editUploadedFileData = null;
      document.getElementById('editFileUploaded').style.display = 'none';
    }
    if (assignModal.style.display === 'flex') assignModal.style.display = 'none';
    if (searchModal.style.display === 'flex') {
      searchModal.style.display = 'none';
      searchFilter.value = '';
    }
    if (toneModal.style.display === 'flex') toneModal.style.display = 'none';
  }
});

async function addSongToDOM(song, id) {
  let block = document.querySelector(`.calendar-block[data-date='${song.date}']`);
  if (!block) {
    block = document.createElement("div");
    block.classList.add("calendar-block");
    block.dataset.date = song.date;
    block.innerHTML = `<div class="calendar-date">${song.date}</div>
      <div class="table-container"><table><thead><tr><th>Video</th><th>Nombre</th><th>Cifrado PDF</th><th>Tono</th><th>Músicos</th>${loggedIn?"<th>Acciones</th>":""}</tr></thead><tbody></tbody></table></div>`;
    document.getElementById("calendarContainer").appendChild(block);
  }

  const tbody = block.querySelector("tbody");
  const tr = document.createElement("tr");

  const tdVideo = document.createElement("td");
  if (song.video) {
    const vid = extractYouTubeID(song.video);
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile && vid) {
      const thumb = document.createElement('div');
      thumb.className = 'video-thumb';
      const link = document.createElement('a');
      link.href = `https://youtu.be/${vid}`;
      link.target = '_blank';
      link.rel = 'noopener';
      const img = document.createElement('img');
      img.src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
      img.alt = 'Thumbnail';
      link.appendChild(img);
      thumb.appendChild(link);
      tdVideo.appendChild(thumb);
    } else {
      tdVideo.innerHTML = vid ? `<iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>` : "Link no válido";
    }
  }

  const tdName = document.createElement("td");
  tdName.textContent = song.songName || "Sin nombre";
  tdName.style.fontWeight = "600";
  tdName.style.color = "#4A90E2";

  const tdFile = document.createElement("td");
  const fileURL = song.fileURL || "";

  if (fileURL) {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
      const btn = document.createElement('a');
      btn.href = fileURL;
      btn.download = song.fileName || 'cifrado.pdf';
      btn.target = '_blank';
      btn.rel = 'noopener noreferrer';
      btn.style.cssText = 'display:inline-block;padding:10px 16px;background:#28a745;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.9em;';
      btn.textContent = '📥 Descargar PDF';
      
      tdFile.style.textAlign = 'center';
      tdFile.appendChild(btn);
    } else {
      tdFile.innerHTML = `<a href="${fileURL}" target="_blank" rel="noopener">${song.fileName || 'Ver PDF'}</a>`;
    }
  } else {
    tdFile.textContent = "Sin PDF";
    tdFile.style.color = "#999";
  }

  const tdChords = document.createElement("td");
  tdChords.textContent = song.chords || "";

  const tdNote = document.createElement("td");
  if (song.musicos && song.musicos.__sameMusicians) {
    tdNote.textContent = "MISMOS MÚSICOS";
    tdNote.style.fontWeight = "bold";
    tdNote.style.color = "#FF9800";
    tdNote.style.fontSize = "0.95em";
  } else {
    tdNote.textContent = song.musicos ? Object.entries(song.musicos).filter(([k]) => k !== '__sameMusicians').map(([k,v])=>`${k}: ${v}`).join('\n') : "";
  }

  tr.append(tdVideo, tdName, tdFile, tdChords, tdNote);

  if (loggedIn) {
    const tdActions = document.createElement("td");
    tdActions.classList.add("actions");

    const edit = document.createElement("button");
    edit.textContent = "Modificar";
    edit.classList.add("edit");
    edit.onclick = () => {
      currentEditId = id;
      currentEditSong = song;
      editVideo.value = song.video || "";
      editSongName.value = song.songName || "";
      editChords.value = song.chords || "";
      editDate.value = song.date || "";
      window.editUploadedFileData = null;
      document.getElementById('editFileUploaded').style.display = 'none';
      buildEditAssignFields(song.musicos || {});
      editModal.style.display = "flex";
    };

    tdActions.append(edit);
    tr.append(tdActions);
  }

  tbody.append(tr);
}

async function renderSongs() {
  const container = document.getElementById("calendarContainer");
  container.innerHTML = "";
  try {
    const querySnapshot = await getDocs(collection(db, "songs"));
    querySnapshot.forEach(docSnap => addSongToDOM(docSnap.data(), docSnap.id));
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p style='text-align:center;color:#D9534F;'>Error cargando canciones</p>";
  }
}

document.getElementById("saveEdit").onclick = async () => {
  if (!currentEditId) return alert("No hay canción seleccionada.");
  try {
    const updates = {};
    const newVideo = editVideo.value.trim();
    const newSongName = editSongName.value.trim();
    const newChords = editChords.value.trim();
    const newDate = editDate.value;

    if (newVideo) updates.video = newVideo;
    else if (currentEditSong?.video) updates.video = currentEditSong.video;

    if (newSongName) updates.songName = newSongName;
    else if (currentEditSong?.songName) updates.songName = currentEditSong.songName;

    if (newChords) updates.chords = newChords;
    else if (currentEditSong?.chords) updates.chords = currentEditSong.chords;

    if (newDate) updates.date = newDate;
    else if (currentEditSong?.date) updates.date = currentEditSong.date;

    const newMusicos = {};
    instruments.forEach(instr => {
      const sel = document.getElementById(`editsel-${instr.replace(/\s+/g,'_')}`);
      if (sel && sel.value) newMusicos[instr] = sel.value;
    });
    if (Object.keys(newMusicos).length > 0) updates.musicos = newMusicos;
    else if (currentEditSong?.musicos) updates.musicos = currentEditSong.musicos;

    if (window.editUploadedFileData) {
      updates.fileURL = window.editUploadedFileData.fileURL;
      updates.fileName = window.editUploadedFileData.fileName;
    } else {
      if (currentEditSong?.fileURL) {
        updates.fileURL = currentEditSong.fileURL;
        if (currentEditSong.fileName) updates.fileName = currentEditSong.fileName;
      }
    }

    await updateDoc(doc(db, "songs", currentEditId), updates);
    alert("✅ Cambios guardados.");
    editModal.style.display = "none";
    currentEditId = null;
    currentEditSong = null;
    window.editUploadedFileData = null;
    document.getElementById('editFileUploaded').style.display = 'none';
    renderSongs();
  } catch (err) {
    console.error(err);
    alert("❌ Error al guardar cambios: " + (err.message || err));
  }
};

document.getElementById("addLine").onclick = async () => {
  const url = document.getElementById("videoURL").value.trim();
  const songName = document.getElementById("songName").value.trim();
  const chords = document.getElementById("chords").value.trim();
  const date = document.getElementById("customDate").value;

  if (!date) return alert("Por favor, elige una fecha.");
  if (!songName) return alert("Por favor, ingresa el nombre de la canción.");

  try {
    const songData = {
      video: url,
      songName,
      chords,
      date,
      musicos: selectedMusicians
    };

    if (window.uploadedFileData) {
      songData.fileName = window.uploadedFileData.fileName;
      songData.fileURL = window.uploadedFileData.fileURL;
    }

    await addDoc(collection(db, "songs"), songData);
    alert("✅ Canción agregada correctamente.");
    document.getElementById("videoURL").value = "";
    document.getElementById("songName").value = "";
    document.getElementById("chords").value = "";
    document.getElementById("customDate").value = "";
    selectedMusicians = {};
    window.uploadedFileData = null;
    document.getElementById('fileUploaded').style.display = 'none';
    
    renderSongs();
  } catch (err) {
    console.error("Error completo:", err);
    alert("❌ Error: " + (err.message || "falló al guardar"));
  }
};

</script>

<script>
let uploadcareAttempts = 0;
const MAX_ATTEMPTS = 300;

function initUploadcare() {
  uploadcareAttempts++;
  
  if (typeof uploadcare === 'undefined') {
    if (uploadcareAttempts < MAX_ATTEMPTS) {
      setTimeout(initUploadcare, 100);
    } else {
      console.error('❌ ERROR: Uploadcare no se cargó después de 30 segundos');
      alert('Error: No se pudo cargar el sistema de archivos. Por favor recarga la página.');
    }
    return;
  }
  
  document.getElementById("uploadBtn").onclick = () => {
    uploadcare.openDialog(null, {
      tabs: 'file',
      multiple: false,
      imagesOnly: false,
      inputAcceptTypes: '.pdf'
    }).done((file) => {
      file.promise()
        .done((fileInfo) => {
          window.uploadedFileData = {
            fileName: fileInfo.name,
            fileURL: fileInfo.cdnUrl
          };
          document.getElementById('fileUploaded').textContent = '✅ ' + window.uploadedFileData.fileName;
          document.getElementById('fileUploaded').style.display = 'block';
          document.getElementById('fileUploaded').style.color = '#28a745';
        })
        .fail((error) => {
          alert('Error al subir el archivo: ' + error);
          document.getElementById('fileUploaded').textContent = '❌ Error: ' + error;
          document.getElementById('fileUploaded').style.display = 'block';
          document.getElementById('fileUploaded').style.color = '#D9534F';
        })
        .progress((progress) => {
          document.getElementById('fileUploaded').textContent = '⏳ Subiendo... ' + Math.round(progress.progress * 100) + '%';
          document.getElementById('fileUploaded').style.display = 'block';
          document.getElementById('fileUploaded').style.color = '#4A90E2';
        });
    });
  };

  document.getElementById("editUploadBtn").onclick = () => {
    uploadcare.openDialog(null, {
      tabs: 'file',
      multiple: false,
      imagesOnly: false,
      inputAcceptTypes: '.pdf'
    }).done((file) => {
      file.promise()
        .done((fileInfo) => {
          window.editUploadedFileData = {
            fileName: fileInfo.name,
            fileURL: fileInfo.cdnUrl
          };
          document.getElementById('editFileUploaded').textContent = '✅ ' + window.editUploadedFileData.fileName;
          document.getElementById('editFileUploaded').style.display = 'block';
          document.getElementById('editFileUploaded').style.color = '#28a745';
        })
        .fail((error) => {
          alert('Error al subir el archivo: ' + error);
          document.getElementById('editFileUploaded').textContent = '❌ Error: ' + error;
          document.getElementById('editFileUploaded').style.display = 'block';
          document.getElementById('editFileUploaded').style.color = '#D9534F';
        })
        .progress((progress) => {
          document.getElementById('editFileUploaded').textContent = '⏳ Subiendo... ' + Math.round(progress.progress * 100) + '%';
          document.getElementById('editFileUploaded').style.display = 'block';
          document.getElementById('editFileUploaded').style.color = '#4A90E2';
        });
    });
  };
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initUploadcare);
} else {
  initUploadcare();
}
</script>
</body>
</html>