<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Calendario Worship PDC</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
/* ========== TU ESTILO ORIGINAL (sin tocar funcionalidad) ========== */
body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f9f9fb;color:#333;margin:15px;}
h1{text-align:center;color:#4A90E2;font-weight:700;margin-bottom:10px;text-shadow:1px 1px 2px rgba(74,144,226,0.5);user-select:none;}
.hidden{display:none;}
form,.calendar-block{width:100%;max-width:1100px;margin:0 auto 15px auto;}
table{width:100%;border-collapse:collapse;margin-top:5px;table-layout:fixed;}
table th:nth-child(1),table td:nth-child(1){width:18%;}
table th:nth-child(2),table td:nth-child(2){width:28%;}
table th:nth-child(3),table td:nth-child(3){width:12%;}
table th:nth-child(4),table td:nth-child(4){width:25%;}
table th:nth-child(5),table td:nth-child(5){width:10%;}
table th:nth-child(6),table td:nth-child(6){width:7%;}
th,td{border:1px solid #ccc;padding:5px 6px;text-align:center;vertical-align:middle;font-size:0.9em;}
th{background:linear-gradient(135deg,#4A90E2,#357ABD);color:white;font-weight:600;}
input[type=text],input[type=url],input[type=date],input[type=password],input[type=file]{width:95%;padding:4px 5px;border-radius:4px;border:1px solid #bbb;font-size:0.85em;box-sizing:border-box;}
button{background-color:#4A90E2;border:none;color:white;padding:5px 10px;font-size:0.85em;font-weight:600;border-radius:5px;cursor:pointer;transition:background-color 0.3s ease;}
button:hover{background-color:#357ABD;}
.assign-green{background-color:#28a745;color:white;font-weight:600;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;transition:background-color 0.3s ease;display:block;margin:5px auto;}
.assign-green:hover{background-color:#218838;}
iframe{max-width:180px;height:90px;display:block;margin:4px auto;border-radius:6px;}
a{word-break:break-word;display:inline-block;font-size:0.8em;color:#274D87;text-decoration:none;}
a:hover{text-decoration:underline;}
.actions button{margin:2px 4px;font-size:0.75em;padding:3px 6px;border-radius:4px;}
.actions .edit{background-color:#F0AD4E;}
.actions .delete{background-color:#D9534F;}
#loginSection{max-width:360px;margin:50px auto;padding:20px;border-radius:10px;background:rgba(255,255,255,0.95);box-shadow:0 6px 20px rgba(0,0,0,0.15);border:1px solid rgba(74,144,226,0.3);text-align:center;}
#loginSection img{width:150px;margin-bottom:10px;}
#loginSection h2{margin-bottom:10px;color:#4A90E2;text-align:center;}
#errorMsg{color:#D9534F;text-align:center;margin-bottom:8px;}
.calendar-block{border:2px solid #4A90E2;border-radius:8px;background:#fff;margin-bottom:15px;box-shadow:0 0 8px rgba(74,144,226,0.1);padding:0;overflow:hidden;}
.calendar-date{background:#4A90E2;color:white;padding:5px;border-radius:8px 8px 0 0;font-weight:600;text-align:center;font-size:1em;}
#loginBtn,#logoutBtn{position:absolute;top:15px;right:25px;}

/* Modal backdrops (me aseguro que queden por encima del overlay) */
#assignModal,#searchModal,#toneModal,#editModal{
  position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;
  align-items:center;justify-content:center;z-index:10010;padding:20px;box-sizing:border-box;
}
#assignContent,#searchContent,#toneContent,#editContent{background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,0.25);box-sizing:border-box;z-index:10020;}
#assignContent{width:280px;}
#searchContent{width:500px;max-height:80vh;overflow-y:auto;}
#toneContent{width:300px;}
/* EDIT modal improvements */
#editContent{
  width:420px; max-width:100%; max-height:85vh; display:flex; flex-direction:column;
  gap:8px; padding:12px 14px;
}
#assignContent h3,#searchContent h3,#toneContent h3,#editContent h3{color:#4A90E2;text-align:center;margin-bottom:8px;}
.assign-item{margin:6px 0;display:flex;flex-direction:column;}
.assign-item label{font-weight:bold;margin-bottom:3px;}
.assign-item select{padding:4px;border:1px solid #ccc;border-radius:5px;font-size:0.85em;}
td:nth-child(4){white-space:pre-line;text-align:left;font-size:0.9em;}
.video-result{display:flex;align-items:center;gap:10px;border-bottom:1px solid #ccc;padding:8px;}
.video-result iframe{width:120px;height:70px;}
.video-result button{background:#28a745;padding:4px 8px;font-size:0.75em;}
.tone-btn{margin-left:4px;padding:4px 7px;font-size:0.9em;border-radius:6px;background:#4A90E2;color:#fff;cursor:pointer;border:none;}
.tone-option{display:inline-block;margin:6px 6px;padding:6px 10px;background:#f0f0f0;border-radius:5px;cursor:pointer;}
.tone-option:hover{background:#4A90E2;color:#fff;}

/* Scrollable body inside edit modal */
.edit-body{overflow:auto; padding-right:6px;}

/* Footer always visible inside modal */
.edit-footer{
  display:flex; gap:10px; justify-content:center; align-items:center; padding-top:8px;
  border-top:1px solid #eee; margin-top:6px; background:transparent; flex-shrink:0;
}
/* Make sure buttons inside modal are clearly visible */
.edit-footer button{min-width:120px;}

/* Small screens adjustments */
@media (max-width:480px){
  #editContent{width:100%; padding:10px;}
  .edit-footer button{min-width:100px; font-size:0.85em;}
}

/* ========== OVERLAY BLACK GLASS LOGIN ========== */
#accessOverlay{
  position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;
  background:linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.85));
  backdrop-filter: blur(6px);
  transition:opacity 360ms ease;
}
.overlay-card{
  width:100%;max-width:540px;border-radius:14px;padding:28px;box-sizing:border-box;
  background:linear-gradient(180deg, rgba(10,10,12,0.6), rgba(6,6,8,0.45));
  border:1px solid rgba(255,255,255,0.06);
  box-shadow:0 12px 40px rgba(0,0,0,0.6);
  color:#fff;text-align:center;position:relative;overflow:hidden;
  backdrop-filter: blur(10px) saturate(1.05);
}
.overlay-card .logo{width:220px;margin:0 auto 18px auto;display:block;filter:drop-shadow(0 8px 30px rgba(0,0,0,0.6));}
.overlay-card h2{margin:4px 0 14px 0;font-size:1.35rem;color:#ffd54a;}
.choiceBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:16px;}
.choiceBtns button{min-width:140px;padding:10px 14px;border-radius:10px;font-size:1rem;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);color:#fff;}
.choiceBtns button:hover{background:rgba(255,255,255,0.08);}
.formBox{margin-top:8px;display:none;flex-direction:column;align-items:center;gap:8px;}
.formBox input{width:90%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.04);color:#fff;text-align:center;font-size:0.95rem;}
.formBox .row{display:flex;gap:8px;width:90%;}
.formBox .row input{flex:1;}
.formBox .actions{display:flex;gap:8px;justify-content:center;width:90%;}
.smallMsg{margin-top:8px;color:#ffb3b3;font-weight:600;min-height:18px;}
.closeOverlay{position:absolute;top:10px;right:12px;background:transparent;border:none;color:rgba(255,255,255,0.5);font-size:1.1rem;padding:6px;border-radius:8px;}
.closeOverlay:hover{color:#fff;background:rgba(255,255,255,0.03);}
.hiddenVis{display:none!important;}
/* Prevent background scroll while overlay active */
body.overlayLocked{overflow:hidden;height:100vh;}

/* =========================
   RESPONSIVE / MOBILE FIXES - PDF SIN GOOGLE DOCS VIEWER
   ========================= */

/* horizontal scroll for tables on small screens */
.table-container{width:100%;overflow:auto;-webkit-overflow-scrolling:touch;}

/* mobile thumbnails and layout */
.video-thumb{display:inline-block;width:160px;height:90px;border-radius:6px;overflow:hidden;background:#000;color:#fff;vertical-align:middle;}
.video-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
.play-overlay{position:relative;display:flex;align-items:center;justify-content:center;height:100%;}
.play-btn{background:rgba(74,144,226,0.95);border:none;color:#fff;border-radius:50%;width:44px;height:44px;font-size:18px;display:flex;align-items:center;justify-content:center;}

/* PDF MOBILE OPTIMIZATION - SIN GOOGLE DOCS VIEWER */
.pdf-container-mobile {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: center;
  justify-content: center;
  padding: 8px;
}

.pdf-btn-mobile {
  display: inline-block;
  padding: 10px 16px;
  background: #4A90E2;
  color: #fff;
  border-radius: 8px;
  text-decoration: none;
  font-weight: 600;
  min-width: 120px;
  text-align: center;
  transition: background-color 0.3s ease;
}

.pdf-btn-mobile:hover {
  background: #357ABD;
  color: #fff;
}

.pdf-btn-secondary {
  background: #6c757d;
  font-size: 0.85em;
  padding: 6px 12px;
  min-width: 100px;
}

.pdf-btn-secondary:hover {
  background: #5a6268;
}

.pdf-filename {
  font-size: 0.85em;
  color: #666;
  text-align: center;
  margin-top: 4px;
  word-break: break-word;
}

/* Small phone adjustments */
@media (max-width:520px){
  table{min-width:700px;table-layout:auto;}
  th,td{padding:8px;border:1px solid #ddd;font-size:0.92em;}
  .assign-green{width:100%;box-sizing:border-box;}
  .overlay-card{padding:18px;}
  body.overlayLocked h1{ margin-top:48px; } /* evita que el X del overlay tape el h1 */
}

/* Desktop: ensure thumbs hidden (we prefer iframe) */
@media (min-width:521px){
  .video-thumb, .play-overlay, .play-btn { display:none !important; }
}
</style>
</head>
<body class="overlayLocked">
<h1>Calendario Worship PDC</h1>
<!-- Mantengo tus botones (se controlan por JS) -->
<button id="loginBtn" class="hidden">Login</button>
<button id="logoutBtn" class="hidden">Cerrar sesi√≥n</button>

<!-- ========== OVERLAY DE ACCESO (BLACK GLASS) ========== -->
<div id="accessOverlay" role="dialog" aria-modal="true" aria-label="Acceso al sitio">
  <div class="overlay-card" role="document">
    <button class="closeOverlay" id="overlayClose" title="Cerrar">&times;</button>
    <img src="imagen1.jpg" alt="Logo PDC" class="logo" />
    <h2>Bienvenido a Worship PDC</h2>

    <div class="choiceBtns" id="loginChoices">
      <button id="visitorChoice">Entrar como Visitante</button>
      <button id="adminChoice">Login Admin</button>
    </div>

    <!-- Visitante: solo contrase√±a -->
    <div id="visitorBox" class="formBox" aria-hidden="true">
      <input id="visitorPass" type="password" placeholder="Contrase√±a visitante" autocomplete="off" />
      <div class="actions">
        <button id="visitorSubmit">Entrar</button>
        <button id="visitorCancel">Volver</button>
      </div>
    </div>

    <!-- Admin: usuario + contrase√±a -->
    <div id="adminBox" class="formBox" aria-hidden="true">
      <input id="adminUser" type="text" placeholder="Usuario" autocomplete="off" />
      <input id="adminPass" type="password" placeholder="Contrase√±a" autocomplete="off" />
      <div class="actions">
        <button id="adminSubmit">Entrar</button>
        <button id="adminCancel">Volver</button>
      </div>
    </div>

    <div id="overlayError" class="smallMsg" aria-live="polite"></div>
  </div>
</div>
<!-- ========== FIN OVERLAY ========== -->

<!-- ========== TU CONTENIDO PRINCIPAL (sin cambios funcionales) ========== -->
<div id="mainContent" class="hidden">
  <form id="lineForm" class="hidden">
    <div class="table-container">
      <table>
        <tr>
          <th>Video YouTube</th>
          <th>Cifrado PDF</th>
          <th>Tono</th>
          <th>M√∫sicos</th>
          <th>Fecha</th>
          <th class="action-header">Acci√≥n</th>
        </tr>
        <tr>
          <td>
            <div style="display:flex;align-items:center;gap:5px;">
              <input type="url" id="videoURL" placeholder="https://..."/>
              <button type="button" id="searchVideoBtn">Buscar</button>
            </div>
          </td>
          <td><input type="file" id="fileUpload" accept="application/pdf"/></td>
          <td>
            <div style="display:flex;align-items:center;gap:5px;justify-content:center;">
              <input type="text" id="chords" placeholder="Ej: G - D - Em"/>
              <button type="button" id="toneBtn" class="tone-btn" title="Elegir tono">üéµ</button>
            </div>
          </td>
          <td><button type="button" id="assignBtn" class="assign-green">Asignar m√∫sicos</button></td>
          <td><input type="date" id="customDate"/></td>
          <td class="action-cell"><button type="button" id="addLine">Agregar</button></td>
        </tr>
      </table>
    </div>
  </form>

  <h2 style="text-align:center;color:#4A90E2;">Lista multimedia</h2>
  <div id="calendarContainer"></div>
</div>

<!-- Modales y editModal (sin cambios funcionales) -->
<div id="toneModal"><div id="toneContent"><h3>Seleccionar Tono</h3><div id="toneOptions" style="text-align:center;"></div><div style="text-align:center;margin-top:12px;"><button id="closeTone">Cerrar</button></div></div></div>
<div id="assignModal"><div id="assignContent"><h3>Asignar M√∫sicos</h3><div id="assignFields"></div><div style="text-align:center;margin-top:10px;"><button id="saveAssign">Guardar</button><button id="closeAssign">Cerrar</button></div></div></div>
<div id="searchModal"><div id="searchContent"><h3>Buscar Video</h3><div id="videoList"></div><div style="text-align:center;margin-top:10px;"><button id="closeSearch">Cerrar</button></div></div></div>

<div id="editModal" aria-hidden="true">
  <div id="editContent" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <h3 id="editTitle">Modificar Canci√≥n</h3>
    <div class="edit-body">
      <label for="editVideo">Video YouTube</label>
      <input type="url" id="editVideo" placeholder="https://..." />
      <label for="editFile">Cifrado PDF (subir nuevo si deseas)</label>
      <input type="file" id="editFile" accept="application/pdf" />
      <label for="editChords">Tono</label>
      <input type="text" id="editChords" placeholder="Ej: G mayor" />
      <div id="editAssignFields"></div>
      <label for="editDate">Fecha</label>
      <input type="date" id="editDate" />
    </div>
    <div class="edit-footer">
      <button id="saveEdit">Guardar cambios</button>
      <button id="cancelEdit">Cancelar</button>
    </div>
  </div>
</div>

<!-- ==================== SCRIPT (integrado y adaptado) ==================== -->
<script type="module">
/* Firebase (igual que antes) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhWpUt9cfxa21T8ijfUCIJuApWBBaBUJQ",
  authDomain: "worship-pdc.firebaseapp.com",
  projectId: "worship-pdc",
  storageBucket: "worship-pdc.appspot.com",
  messagingSenderId: "132891019857",
  appId: "1:132891019857:web:3d72cfe959a8d14cdf4670"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ========== Credenciales (local validation for now) ========== */
const VISITOR_PASSWORD = "pdc2025*";
const ADMIN_USER = "ADMINPDC";
const ADMIN_PASS = "worship1039";

/* Estado de sesi√≥n */
let loggedIn = false;
let visitorLogged = false;

/* Elementos del overlay */
const accessOverlay = document.getElementById("accessOverlay");
const visitorChoice = document.getElementById("visitorChoice");
const adminChoice = document.getElementById("adminChoice");
const visitorBox = document.getElementById("visitorBox");
const adminBox = document.getElementById("adminBox");
const visitorPass = document.getElementById("visitorPass");
const adminUser = document.getElementById("adminUser");
const adminPass = document.getElementById("adminPass");
const visitorSubmit = document.getElementById("visitorSubmit");
const visitorCancel = document.getElementById("visitorCancel");
const adminSubmit = document.getElementById("adminSubmit");
const adminCancel = document.getElementById("adminCancel");
const overlayError = document.getElementById("overlayError");
const overlayClose = document.getElementById("overlayClose");

const mainContent = document.getElementById("mainContent");
const lineForm = document.getElementById("lineForm");
const logoutBtn = document.getElementById("logoutBtn");

/* Helper: extraer ID de YouTube (m√°s robusto que regex inline) */
function extractYouTubeID(url) {
  if (!url) return null;
  const m = url.match(/(?:v=|youtu\.be\/|\/embed\/)([^&?/]+)/);
  return m ? m[1] : null;
}

/* Mantenimiento: evita que se cargue el contenido antes del login. */
function showOverlay() {
  if (accessOverlay) accessOverlay.style.display = "flex";
  document.body.classList.add("overlayLocked");
  if (overlayError) overlayError.textContent = "";
  if (visitorBox) visitorBox.style.display = "none";
  if (adminBox) adminBox.style.display = "none";
  const choices = document.getElementById("loginChoices");
  if (choices) choices.style.display = "flex";
  try { if (visitorPass) visitorPass.value = ""; if (adminUser) adminUser.value = ""; if (adminPass) adminPass.value = ""; } catch(e){}
}
function hideOverlay() {
  if (accessOverlay) accessOverlay.style.display = "none";
  document.body.classList.remove("overlayLocked");
}

/* Determina lo que ver√° cada rol */
function enterAsVisitor() {
  visitorLogged = true;
  loggedIn = false;
  hideOverlay();
  if (mainContent) mainContent.classList.remove("hidden");
  if (lineForm) lineForm.classList.add("hidden");
  if (logoutBtn) logoutBtn.classList.remove("hidden");
  renderSongs();
  try { localStorage.setItem("worship_role", "visitor"); } catch(e){}
}
function enterAsAdmin() {
  visitorLogged = false;
  loggedIn = true;
  hideOverlay();
  if (mainContent) mainContent.classList.remove("hidden");
  if (lineForm) lineForm.classList.remove("hidden");
  if (logoutBtn) logoutBtn.classList.remove("hidden");
  renderSongs();
  try { localStorage.setItem("worship_role", "admin"); } catch(e){}
}

/* Restaurar sesi√≥n si existe */
function restoreSession() {
  try {
    const role = localStorage.getItem("worship_role");
    if (role === "admin") enterAsAdmin();
    else if (role === "visitor") enterAsVisitor();
    else showOverlay();
  } catch (e) {
    showOverlay();
  }
}

/* Overlay interactions */
if (visitorChoice) visitorChoice.onclick = () => {
  const choices = document.getElementById("loginChoices");
  if (choices) choices.style.display = "none";
  if (visitorBox) visitorBox.style.display = "flex";
  if (adminBox) adminBox.style.display = "none";
  if (overlayError) overlayError.textContent = "";
};
if (adminChoice) adminChoice.onclick = () => {
  const choices = document.getElementById("loginChoices");
  if (choices) choices.style.display = "none";
  if (adminBox) adminBox.style.display = "flex";
  if (visitorBox) visitorBox.style.display = "none";
  if (overlayError) overlayError.textContent = "";
};
if (visitorCancel) visitorCancel.onclick = () => {
  if (visitorBox) visitorBox.style.display = "none";
  const choices = document.getElementById("loginChoices");
  if (choices) choices.style.display = "flex";
  if (overlayError) overlayError.textContent = "";
};
if (adminCancel) adminCancel.onclick = () => {
  if (adminBox) adminBox.style.display = "none";
  const choices = document.getElementById("loginChoices");
  if (choices) choices.style.display = "flex";
  if (overlayError) overlayError.textContent = "";
};
if (overlayClose) overlayClose.onclick = () => {
  if (visitorBox) visitorBox.style.display = "none";
  if (adminBox) adminBox.style.display = "none";
  const choices = document.getElementById("loginChoices");
  if (choices) choices.style.display = "flex";
  if (overlayError) overlayError.textContent = "";
};

/* Validaciones (local) */
if (visitorSubmit) visitorSubmit.onclick = () => {
  const pass = (visitorPass && visitorPass.value) ? visitorPass.value.trim() : "";
  if (!pass) { if (overlayError) overlayError.textContent = "Ingresa la contrase√±a de visitante."; return; }
  if (pass === VISITOR_PASSWORD) enterAsVisitor(); else if (overlayError) overlayError.textContent = "Contrase√±a visitante incorrecta.";
};
if (adminSubmit) adminSubmit.onclick = () => {
  const user = (adminUser && adminUser.value) ? adminUser.value.trim() : "";
  const pass = (adminPass && adminPass.value) ? adminPass.value.trim() : "";
  if (!user || !pass) { if (overlayError) overlayError.textContent = "Ingresa usuario y contrase√±a."; return; }
  if (user === ADMIN_USER && pass === ADMIN_PASS) enterAsAdmin(); else if (overlayError) overlayError.textContent = "Usuario o contrase√±a admin incorrectos.";
};

/* Logout */
if (logoutBtn) logoutBtn.onclick = () => {
  loggedIn = false;
  visitorLogged = false;
  try { localStorage.removeItem("worship_role"); } catch(e){}
  if (mainContent) mainContent.classList.add("hidden");
  if (lineForm) lineForm.classList.add("hidden");
  if (logoutBtn) logoutBtn.classList.add("hidden");
  showOverlay();
};

/* Restaurar sesi√≥n al cargar */
restoreSession();

/* ===================== Resto de tu l√≥gica original (sin tocar funcionalidad) ===================== */

/* Asignar m√∫sicos */
const instruments = ["BATERIA","PIANO","GUITARRA ACUSTICA","GUITARRA ELECTRICA","VOZ 1","VOZ 2","VOZ 3","VOZ LIDER","BAJO"];
const names = ["Rafael","Moises","Ronald","Nelson","Josue","Sebastian","Jose","Nayuris","Gabriela","Daniela","Carolina","Adriana"];
let selectedMusicians = {};
const assignBtn = document.getElementById("assignBtn");
const assignModal = document.getElementById("assignModal");
const assignFields = document.getElementById("assignFields");
const saveAssign = document.getElementById("saveAssign");
const closeAssign = document.getElementById("closeAssign");

function openAssignModal() {
  assignFields.innerHTML = "";
  instruments.forEach(instr => {
    const div = document.createElement("div");
    div.classList.add("assign-item");
    div.innerHTML = `<label>${instr}:</label>
      <select id="sel-${instr.replace(/\s+/g,'_')}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}" ${selectedMusicians[instr]===n?'selected':''}>${n}</option>`).join('')}
      </select>`;
    assignFields.appendChild(div);
  });
  if (assignModal) assignModal.style.display = "flex";
}
if (assignBtn) assignBtn.onclick = () => { if (!loggedIn) return alert("Debes iniciar sesi√≥n"); openAssignModal(); };
if (closeAssign) closeAssign.onclick = () => { if (assignModal) assignModal.style.display = "none"; };
if (saveAssign) saveAssign.onclick = () => {
  instruments.forEach(instr=>{
    const sel = document.getElementById(`sel-${instr.replace(/\s+/g,'_')}`);
    if (sel) {
      const val = sel.value;
      if (val) selectedMusicians[instr] = val; else delete selectedMusicians[instr];
    }
  });
  if (assignModal) assignModal.style.display = "none";
  alert("Asignaciones guardadas correctamente.");
};

/* Tono */
const toneBtn = document.getElementById("toneBtn");
const toneModal = document.getElementById("toneModal");
const toneOptions = document.getElementById("toneOptions");
const closeTone = document.getElementById("closeTone");
const chordsInput = document.getElementById("chords");
const baseNotes = ["C","C#","Db","D","D#","Eb","E","F","F#","Gb","G","G#","Ab","A","A#","Bb","B"];
function buildToneOptions() {
  if (!toneOptions) return;
  toneOptions.innerHTML = "";
  baseNotes.forEach(n => {
    const maj = document.createElement("div");
    maj.className = "tone-option";
    maj.textContent = `${n} mayor`;
    maj.onclick = () => { if (chordsInput) chordsInput.value = maj.textContent; if (toneModal) toneModal.style.display = "none"; };
    toneOptions.appendChild(maj);
    const min = document.createElement("div");
    min.className = "tone-option";
    min.textContent = `${n} menor`;
    min.onclick = () => { if (chordsInput) chordsInput.value = min.textContent; if (toneModal) toneModal.style.display = "none"; };
    toneOptions.appendChild(min);
  });
}
if (toneBtn) toneBtn.onclick = () => { buildToneOptions(); if (toneModal) toneModal.style.display = "flex"; };
if (closeTone) closeTone.onclick = () => { if (toneModal) toneModal.style.display = "none"; };

/* Buscar video */
const searchVideoBtn = document.getElementById("searchVideoBtn");
const searchModal = document.getElementById("searchModal");
const videoList = document.getElementById("videoList");
const closeSearch = document.getElementById("closeSearch");

if (searchVideoBtn) searchVideoBtn.onclick = async () => {
  if (searchModal) searchModal.style.display = "flex";
  if (videoList) videoList.innerHTML = "<p style='text-align:center;'>Cargando videos...</p>";
  try {
    const snap = await getDocs(collection(db, "songs"));
    if (videoList) videoList.innerHTML = "";
    snap.forEach(docSnap => {
      const song = docSnap.data();
      if (song.video) {
        const idv = extractYouTubeID(song.video);
        const iframeHtml = idv ? `<iframe src='https://www.youtube.com/embed/${idv}' frameborder='0'></iframe>` : "";
        const div = document.createElement("div");
        div.classList.add("video-result");
        div.innerHTML = `${iframeHtml}<div style="flex:1;"><p><strong>${song.date || ''}</strong></p><p style="word-break:break-all;">${song.video}</p></div>`;
        const selBtn = document.createElement("button");
        selBtn.type = "button";
        selBtn.textContent = "Seleccionar";
        selBtn.onclick = () => {
          const v = document.getElementById("videoURL");
          if (v) v.value = song.video;
          if (searchModal) searchModal.style.display = "none";
        };
        div.appendChild(selBtn);
        if (videoList) videoList.appendChild(div);
      }
    });
    if (videoList && videoList.children.length === 0) videoList.innerHTML = "<p style='text-align:center;color:#666;'>No hay videos guardados.</p>";
  } catch (err) {
    console.error(err);
    if (videoList) videoList.innerHTML = "<p style='text-align:center;color:#D9534F;'>Error cargando videos</p>";
  }
};
if (closeSearch) closeSearch.onclick = () => { if (searchModal) searchModal.style.display = "none"; };

/* Upload Gofile (MEJORADA): devuelve objeto con fileURL y fileURLDirect cuando sea posible */
async function uploadToGoFile(file) {
  const formData = new FormData();
  formData.append("file", file);
  const response = await fetch("https://store1.gofile.io/uploadFile", { method: "POST", body: formData });
  const result = await response.json();

  const data = result?.data || {};
  const fileData = {
    // p√°gina de descarga (fallback)
    fileURL: data.downloadPage || data.link || data.downloadPage || "",
    // intento de enlace directo (propiedades que algunas respuestas pueden incluir)
    fileURLDirect: data.directLink || data.downloadUrl || data.download || data.directDownload || ""
  };

  // Heur√≠stica: si la respuesta incluye server y fileId/code intentamos construir un enlace directo
  try {
    if (!fileData.fileURLDirect && data.server && (data.fileId || data.code)) {
      const id = data.fileId || data.code;
      // Nota: esto es heur√≠stico y puede no funcionar en todos los casos
      fileData.fileURLDirect = `https://srv${data.server}.gofile.io/download/${id}/${encodeURIComponent(file.name)}`;
    }
  } catch (e) {
    // ignore
  }

  return fileData; // { fileURL, fileURLDirect }
}

/* Edit modal helpers */
const editModal = document.getElementById("editModal");
const editVideo = document.getElementById("editVideo");
const editFile = document.getElementById("editFile");
const editChords = document.getElementById("editChords");
const editAssignFields = document.getElementById("editAssignFields");
const editDate = document.getElementById("editDate");
const saveEdit = document.getElementById("saveEdit");
const cancelEdit = document.getElementById("cancelEdit");

let currentEditId = null;
let currentEditSong = null;

function buildEditAssignFields(existingMusicos = {}) {
  if (!editAssignFields) return;
  editAssignFields.innerHTML = "<h4 style='text-align:center;margin:8px 0 6px 0;color:#4A90E2;'>M√∫sicos</h4>";
  instruments.forEach(instr => {
    const div = document.createElement("div");
    div.classList.add("assign-item");
    const selId = `editsel-${instr.replace(/\s+/g,'_')}`;
    div.innerHTML = `<label style="font-weight:bold;margin-bottom:3px;">${instr}:</label>
      <select id="${selId}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}" ${existingMusicos[instr]===n?'selected':''}>${n}</option>`).join('')}
      </select>`;
    editAssignFields.appendChild(div);
  });
}

/* Close modal on cancel */
if (cancelEdit) cancelEdit.onclick = () => { if (editModal) editModal.style.display = "none"; currentEditId = null; currentEditSong = null; };

/* Close modal when clicking outside content */
if (editModal) editModal.addEventListener('click', (e) => {
  if (e.target === editModal) {
    editModal.style.display = 'none';
    currentEditId = null;
    currentEditSong = null;
  }
});

/* Close modal with Escape key */
window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (editModal && editModal.style.display === 'flex') { editModal.style.display = 'none'; currentEditId = null; currentEditSong = null; }
    if (assignModal && assignModal.style.display === 'flex') assignModal.style.display = 'none';
    if (searchModal && searchModal.style.display === 'flex') searchModal.style.display = 'none';
    if (toneModal && toneModal.style.display === 'flex') toneModal.style.display = 'none';
  }
});

/* ========== FUNCI√ìN ADDSONGSTODOM CORREGIDA - SIN GOOGLE DOCS VIEWER ========== */
async function addSongToDOM(song, id) {
  let block = document.querySelector(`.calendar-block[data-date='${song.date}']`);
  if (!block) {
    block = document.createElement("div");
    block.classList.add("calendar-block");
    block.dataset.date = song.date;
    block.innerHTML = `<div class="calendar-date">${song.date}</div>
      <div class="table-container"><table><thead><tr><th>Video</th><th>Cifrado PDF</th><th>Tono</th><th>M√∫sicos</th>${loggedIn?"<th>Acciones</th>":""}</tr></thead><tbody></tbody></table></div>`;
    const container = document.getElementById("calendarContainer");
    if (container) container.appendChild(block);
  }

  const tbody = block.querySelector("tbody");
  const tr = document.createElement("tr");

  // VIDEO
  const tdVideo = document.createElement("td");
  tdVideo.dataset.label = "Video";
  if (song.video) {
    const vid = extractYouTubeID(song.video);
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.matchMedia("(max-width:520px)").matches;
    
    if (isMobile && vid) {
      const thumb = document.createElement('div');
      thumb.className = 'video-thumb';
      const link = document.createElement('a');
      link.href = `https://youtu.be/${vid}`;
      link.target = '_blank';
      link.rel = 'noopener';
      const img = document.createElement('img');
      img.src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
      img.alt = `thumb ${vid}`;
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;display:block;';
      img.onerror = function() {
        this.style.display = 'none';
        const placeholder = document.createElement('div');
        placeholder.style.cssText = 'width:100%;height:100%;background:#333;color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;';
        placeholder.textContent = 'Video';
        link.appendChild(placeholder);
      };
      link.appendChild(img);
      thumb.appendChild(link);
      tdVideo.appendChild(thumb);
    } else {
      const idv = vid || '';
      tdVideo.innerHTML = idv ? `<iframe src="https://www.youtube.com/embed/${idv}" frameborder="0" allowfullscreen></iframe>` : "Link no v√°lido";
    }
  } else {
    tdVideo.textContent = "";
  }

  // PDF - SOLUCI√ìN DEFINITIVA SIN GOOGLE DOCS VIEWER
  const tdFile = document.createElement("td");
  tdFile.dataset.label = "Cifrado PDF";
  
  // Usar las propiedades correctas de Firebase
  const direct = song.fileURLDirect || song.fileDirect || "";
  const page = song.fileURL || song.fileURLPage || "";
  const fileName = song.fileName || "";
  
  if (direct || page) {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.matchMedia("(max-width:520px)").matches;
    
    if (isMobile) {
      // M√ìVIL: Botones directos SIN Google Docs Viewer
      const container = document.createElement('div');
      container.className = 'pdf-container-mobile';
      
      const primaryBtn = document.createElement('a');
      primaryBtn.className = 'pdf-btn-mobile';
      primaryBtn.target = '_blank';
      primaryBtn.rel = 'noopener';
      
      if (direct) {
        primaryBtn.href = direct;
        primaryBtn.textContent = 'üìÑ Abrir PDF';
      } else if (page) {
        primaryBtn.href = page;
        primaryBtn.textContent = 'üìÑ Ver PDF';
      }
      
      container.appendChild(primaryBtn);
      
      // Bot√≥n secundario como fallback
      if (direct && page && direct !== page) {
        const secondaryBtn = document.createElement('a');
        secondaryBtn.className = 'pdf-btn-mobile pdf-btn-secondary';
        secondaryBtn.href = page;
        secondaryBtn.target = '_blank';
        secondaryBtn.rel = 'noopener';
        secondaryBtn.textContent = 'P√°gina de descarga';
        container.appendChild(secondaryBtn);
      }
      
      // Mostrar nombre del archivo
      if (fileName) {
        const fileNameDiv = document.createElement('div');
        fileNameDiv.className = 'pdf-filename';
        fileNameDiv.textContent = fileName;
        container.appendChild(fileNameDiv);
      }
      
      tdFile.appendChild(container);
    } else {
      // DESKTOP: enlace simple
      const link = direct || page;
      const linkElement = document.createElement('a');
      linkElement.href = link;
      linkElement.target = '_blank';
      linkElement.rel = 'noopener';
      linkElement.textContent = fileName || 'PDF';
      tdFile.appendChild(linkElement);
    }
  } else {
    tdFile.textContent = "Sin PDF";
  }

  // TONO
  const tdChords = document.createElement("td");
  tdChords.dataset.label = "Tono";
  tdChords.textContent = song.chords || "";

  // M√öSICOS
  const tdNote = document.createElement("td");
  tdNote.dataset.label = "M√∫sicos";
  tdNote.textContent = song.musicos ? Object.entries(song.musicos).map(([k,v])=>`${k}: ${v}`).join('\n') : "";

  tr.append(tdVideo, tdFile, tdChords, tdNote);

  if (loggedIn) {
    const tdActions = document.createElement("td");
    tdActions.dataset.label = "Acciones";
    tdActions.classList.add("actions");

    const edit = document.createElement("button");
    edit.textContent = "Modificar";
    edit.classList.add("edit");
    edit.onclick = () => {
      currentEditId = id;
      currentEditSong = song;
      if (editVideo) editVideo.value = song.video || "";
      if (editChords) editChords.value = song.chords || "";
      if (editFile) editFile.value = "";
      if (editDate) editDate.value = song.date || "";
      buildEditAssignFields(song.musicos || {});
      if (editModal) editModal.style.display = "flex";
    };

    const del = document.createElement("button");
    del.textContent = "Eliminar";
    del.classList.add("delete");
    del.onclick = async () => {
      if (confirm("¬øEliminar esta canci√≥n?")) {
        await deleteDoc(doc(db, "songs", id));
        renderSongs();
      }
    };

    tdActions.append(edit, del);
    tr.append(tdActions);
  }

  tbody.append(tr);
}

/* Renderiza canciones (se llama s√≥lo despu√©s de login/visitor) */
async function renderSongs() {
  const container = document.getElementById("calendarContainer");
  if (container) container.innerHTML = "";
  try {
    const querySnapshot = await getDocs(collection(db, "songs"));
    querySnapshot.forEach(docSnap => addSongToDOM(docSnap.data(), docSnap.id));
  } catch (err) {
    console.error(err);
    if (container) container.innerHTML = "<p style='text-align:center;color:#D9534F;'>Error cargando canciones</p>";
  }
}

/* Guardar edici√≥n (actualiza el doc existente) */
if (saveEdit) saveEdit.onclick = async () => {
  if (!currentEditId) return alert("No hay canci√≥n seleccionada.");
  try {
    const updates = {};
    const newVideo = editVideo && editVideo.value ? editVideo.value.trim() : "";
    const newChords = editChords && editChords.value ? editChords.value.trim() : "";
    const newDate = editDate && editDate.value ? editDate.value : "";

    if (newVideo) updates.video = newVideo;
    else if (currentEditSong && currentEditSong.video) updates.video = currentEditSong.video;

    if (newChords) updates.chords = newChords;
    else if (currentEditSong && currentEditSong.chords) updates.chords = currentEditSong.chords;

    if (newDate) updates.date = newDate;
    else if (currentEditSong && currentEditSong.date) updates.date = currentEditSong.date;

    // recoger m√∫sicos del modal
    const newMusicos = {};
    instruments.forEach(instr => {
      const sel = document.getElementById(`editsel-${instr.replace(/\s+/g,'_')}`);
      if (sel && sel.value) newMusicos[instr] = sel.value;
    });
    if (Object.keys(newMusicos).length > 0) updates.musicos = newMusicos;
    else if (currentEditSong && currentEditSong.musicos) updates.musicos = currentEditSong.musicos;

    // si suben nuevo pdf, subo y agrego fileURL + fileURLDirect + fileName
    if (editFile && editFile.files.length > 0) {
      const file = editFile.files[0];
      const fileData = await uploadToGoFile(file); // { fileURL, fileURLDirect }
      if (fileData.fileURL) updates.fileURL = fileData.fileURL;
      if (fileData.fileURLDirect) updates.fileURLDirect = fileData.fileURLDirect;
      updates.fileName = file.name;
    } else {
      if (currentEditSong && currentEditSong.fileURL) {
        updates.fileURL = currentEditSong.fileURL;
        if (currentEditSong.fileURLDirect) updates.fileURLDirect = currentEditSong.fileURLDirect;
        if (currentEditSong.fileName) updates.fileName = currentEditSong.fileName;
      }
    }

    // ejecutar update
    await updateDoc(doc(db, "songs", currentEditId), updates);
    alert("‚úÖ Cambios guardados.");
    if (editModal) editModal.style.display = "none";
    currentEditId = null;
    currentEditSong = null;
    renderSongs();
  } catch (err) {
    console.error(err);
    alert("‚ùå Error al guardar cambios: " + (err.message || err));
  }
};

/* Agregar canci√≥n */
const addLineBtn = document.getElementById("addLine");
if (addLineBtn) addLineBtn.onclick = async () => {
  const urlEl = document.getElementById("videoURL");
  const url = urlEl ? urlEl.value.trim() : "";
  const fileInput = document.getElementById("fileUpload");
  const chordsEl = document.getElementById("chords");
  const chords = chordsEl ? chordsEl.value.trim() : "";
  const dateEl = document.getElementById("customDate");
  const date = dateEl ? dateEl.value : "";

  if (!date) return alert("Por favor, elige una fecha.");

  try {
    let fileDataToSave = {};
    if (fileInput && fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileData = await uploadToGoFile(file); // { fileURL, fileURLDirect }
      fileDataToSave = {
        fileName: file.name,
        fileURL: fileData.fileURL || "",
        fileURLDirect: fileData.fileURLDirect || ""
      };
    }

    await addDoc(collection(db, "songs"), {
      video: url,
      chords,
      date,
      musicos: selectedMusicians,
      ...fileDataToSave
    });

    alert("‚úÖ Canci√≥n agregada correctamente.");
    if (urlEl) urlEl.value = "";
    if (fileInput) fileInput.value = "";
    if (chordsEl) chordsEl.value = "";
    if (dateEl) dateEl.value = "";
    selectedMusicians = {};
    renderSongs();
  } catch (err) {
    console.error(err);
    alert("‚ùå Error: " + (err.message || "fall√≥ al guardar"));
  }
};

/* Fin del script */
</script>
</body>
</html>