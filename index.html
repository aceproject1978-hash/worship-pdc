<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Calendario Worship PDC</title>
<style>
/* ... (todo tu CSS original se mantiene igual) ... */
</style>
</head>
<body>
<h1>Calendario Worship PDC</h1>
<button id="loginBtn">Login</button>
<button id="logoutBtn" class="hidden">Cerrar sesi√≥n</button>

<div id="loginSection" class="hidden">
  <img src="imagen1.jpg" alt="Logo PDC" />
  <h2>Inicio de Sesi√≥n</h2>
  <div id="errorMsg"></div>
  <input type="text" id="username" placeholder="Usuario" /><br><br>
  <input type="password" id="password" placeholder="Contrase√±a" /><br><br>
  <button id="confirmLogin">Ingresar</button>
  <button id="cancelLogin">Cancelar</button>
</div>

<div id="mainContent">
  <form id="lineForm" class="hidden">
    <table>
      <tr>
        <th>Video YouTube</th>
        <th>Cifrado PDF</th>
        <th>Tono</th>
        <th>M√∫sicos</th>
        <th>Fecha</th>
        <th class="action-header">Acci√≥n</th>
      </tr>
      <tr>
        <td><input type="url" id="videoURL" placeholder="https://..."/></td>
        <td><input type="file" id="fileUpload" accept="application/pdf"/></td>
        <td><input type="text" id="chords" placeholder="Ej: G - D - Em"/></td>
        <td><button type="button" id="assignBtn" class="assign-green">Asignar m√∫sicos</button></td>
        <td><input type="date" id="customDate"/></td>
        <td class="action-cell"><button type="button" id="addLine">Agregar</button></td>
      </tr>
    </table>
  </form>

  <h2 style="text-align:center;color:#4A90E2;">Lista multimedia</h2>
  <div id="calendarContainer"></div>
</div>

<!-- Modal -->
<div id="assignModal">
  <div id="assignContent">
    <h3>Asignar M√∫sicos</h3>
    <div id="assignFields"></div>
    <div style="text-align:center;margin-top:10px;">
      <button id="saveAssign">Guardar</button>
      <button id="closeAssign">Cerrar</button>
    </div>
  </div>
</div>

<!-- üî• CONFIGURACI√ìN FIREBASE Y REGLAS
Aseg√∫rate de tener las reglas correctas en Firebase para permitir el acceso adecuado.

üìÅ Firestore Rules:
service cloud.firestore {
  match /databases/{database}/documents {
    match /songs/{songId} {
      allow read, write: if true; // ‚ö†Ô∏è Solo para pruebas. Usa autenticaci√≥n real despu√©s.
    }
  }
}

üìÅ Storage Rules:
service firebase.storage {
  match /b/{bucket}/o {
    match /pdfs/{allPaths=**} {
      allow read, write: if true; // ‚ö†Ô∏è Solo para pruebas. Ajusta luego.
    }
  }
}
-->

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhWpUt9cfxa21T8ijfUCIJuApWBBaBUJQ",
  authDomain: "worship-pdc.firebaseapp.com",
  projectId: "worship-pdc",
  storageBucket: "worship-pdc.appspot.com",
  messagingSenderId: "132891019857",
  appId: "1:132891019857:web:3d72cfe959a8d14cdf4670"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

const USERNAME = "ADMINPDC";
const PASSWORD = "worship1039";
let loggedIn = false;

const loginBtn = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const loginSection = document.getElementById("loginSection");
const confirmLogin = document.getElementById("confirmLogin");
const cancelLogin = document.getElementById("cancelLogin");
const errorMsg = document.getElementById("errorMsg");
const lineForm = document.getElementById("lineForm");
const calendarContainer = document.getElementById("calendarContainer");

loginBtn.onclick = () => { loginSection.classList.remove("hidden"); loginBtn.classList.add("hidden"); };
cancelLogin.onclick = () => { loginSection.classList.add("hidden"); loginBtn.classList.remove("hidden"); };
confirmLogin.onclick = () => {
  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value.trim();
  if (user === USERNAME && pass === PASSWORD) {
    loggedIn = true;
    loginSection.classList.add("hidden");
    logoutBtn.classList.remove("hidden");
    lineForm.classList.remove("hidden");
    renderSongs();
  } else {
    errorMsg.textContent = "Usuario o contrase√±a incorrectos.";
  }
};
logoutBtn.onclick = () => { loggedIn = false; logoutBtn.classList.add("hidden"); loginBtn.classList.remove("hidden"); lineForm.classList.add("hidden"); renderSongs(); };

const instruments = ["BATERIA","PIANO","GUITARRA ACUSTICA","GUITARRA ELECTRICA","VOZ 1","VOZ 2","VOZ 3","VOZ LIDER","BAJO"];
const names = ["Rafael","Moises","Ronald","Nelson","Josue","Sebastian","Jose","Nayuris","Gabriela","Daniela","Carolina","Adriana"];

const assignBtn = document.getElementById("assignBtn");
const assignModal = document.getElementById("assignModal");
const assignFields = document.getElementById("assignFields");
const saveAssign = document.getElementById("saveAssign");
const closeAssign = document.getElementById("closeAssign");

function openAssignModal() {
  assignFields.innerHTML = "";
  instruments.forEach(instr => {
    const div = document.createElement("div");
    div.classList.add("assign-item");
    div.innerHTML = `<label>${instr}:</label>
      <select id="sel-${instr.replace(/\s+/g,'_')}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}">${n}</option>`).join('')}
      </select>`;
    assignFields.appendChild(div);
  });
  assignModal.style.display = "flex";
}
assignBtn.onclick = () => { if (loggedIn) openAssignModal(); else alert("Debes iniciar sesi√≥n como ADMINPDC"); };
closeAssign.onclick = () => assignModal.style.display = "none";
saveAssign.onclick = () => { assignModal.style.display = "none"; alert("Asignaciones guardadas correctamente."); };

async function addSongToDOM(song, id) {
  let block = document.querySelector(`.calendar-block[data-date='${song.date}']`);
  if (!block) {
    block = document.createElement("div");
    block.classList.add("calendar-block");
    block.dataset.date = song.date;
    block.innerHTML = `<div class="calendar-date">${song.date}</div>
      <table><thead><tr><th>Video</th><th>Cifrado PDF</th><th>Tono</th><th>M√∫sico</th>${loggedIn?"<th>Acciones</th>":""}</tr></thead><tbody></tbody></table>`;
    calendarContainer.appendChild(block);
  }

  const tbody = block.querySelector("tbody");
  const tr = document.createElement("tr");

  const tdVideo = document.createElement("td");
  if (song.video) {
    const idv = song.video.match(/(?:v=|youtu\.be\/)([^&]+)/);
    tdVideo.innerHTML = idv ? `<iframe src="https://www.youtube.com/embed/${idv[1]}" frameborder="0" allowfullscreen></iframe>` : "Link no v√°lido";
  }

  const tdFile = document.createElement("td");
  if (song.fileURL) tdFile.innerHTML = `<a href="${song.fileURL}" target="_blank">${song.fileName}</a>`;

  const tdChords = document.createElement("td");
  tdChords.textContent = song.chords;

  const tdNote = document.createElement("td");
  tdNote.textContent = song.musicos || "";

  tr.append(tdVideo, tdFile, tdChords, tdNote);

  if (loggedIn) {
    const tdActions = document.createElement("td");
    tdActions.classList.add("actions");
    const del = document.createElement("button");
    del.textContent = "Eliminar";
    del.classList.add("delete");
    del.onclick = async () => {
      if (confirm("¬øEliminar esta canci√≥n?")) {
        await deleteDoc(doc(db, "songs", id));
        renderSongs();
      }
    };
    tdActions.append(del);
    tr.append(tdActions);
  }

  tbody.append(tr);
}

async function renderSongs() {
  calendarContainer.innerHTML = "";
  const querySnapshot = await getDocs(collection(db, "songs"));
  querySnapshot.forEach(docSnap => {
    addSongToDOM(docSnap.data(), docSnap.id);
  });
}

document.getElementById("addLine").onclick = async () => {
  const url = document.getElementById("videoURL").value.trim();
  const fileInput = document.getElementById("fileUpload");
  const chords = document.getElementById("chords").value.trim();
  const date = document.getElementById("customDate").value;

  if (!date) return alert("Por favor, elige una fecha.");

  try {
    let fileData = {};
    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileRef = ref(storage, "pdfs/" + file.name);
      await uploadBytes(fileRef, file);
      const fileURL = await getDownloadURL(fileRef);
      fileData = { fileName: file.name, fileURL };
    }

    await addDoc(collection(db, "songs"), { video: url, chords, date, ...fileData });
    alert("‚úÖ Canci√≥n agregada correctamente.");
    document.getElementById("videoURL").value = "";
    document.getElementById("fileUpload").value = "";
    document.getElementById("chords").value = "";
    document.getElementById("customDate").value = "";
    renderSongs();
  } catch (e) {
    console.error("Error al guardar:", e);
    alert("‚ùå Error: " + e.message);
  }
};

renderSongs();
</script>
</body>
</html>
