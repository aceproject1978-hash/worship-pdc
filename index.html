<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Calendario Worship PDC</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
/* ... Todo tu CSS original ... */
body { font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f9f9fb;color:#333;margin:15px;}
/* ... resto igual ... */
</style>
</head>
<body class="overlayLocked">
<h1>Calendario Worship PDC</h1>
<!-- ... TODO TU HTML ORIGINAL, modales, formulario, etc ... -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDhWpUt9cfxa21T8ijfUCIJuApWBBaBUJQ",
  authDomain: "worship-pdc.firebaseapp.com",
  projectId: "worship-pdc",
  storageBucket: "worship-pdc.appspot.com",
  messagingSenderId: "132891019857",
  appId: "1:132891019857:web:3d72cfe959a8d14cdf4670"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// --------- FUNCION DE SUBIDA PDF CON TRANSFER.SH ---------
async function uploadToTransferSH(file) {
  const formData = new FormData();
  formData.append("file", file, file.name);
  // Transfer.sh requiere el nombre en la URL
  const response = await fetch(`https://transfer.sh/${encodeURIComponent(file.name)}`, {
    method: "POST",
    body: file
  });
  const fileURL = await response.text(); // El link viene como texto plano
  return { fileURL: fileURL.trim(), fileName: file.name };
}

// --------- AGREGA CANCIÓN: USA uploadToTransferSH ---------
const addLineBtn = document.getElementById("addLine");
if (addLineBtn) addLineBtn.onclick = async () => {
  const urlEl = document.getElementById("videoURL");
  const url = urlEl ? urlEl.value.trim() : "";
  const fileInput = document.getElementById("fileUpload");
  const chordsEl = document.getElementById("chords");
  const chords = chordsEl ? chordsEl.value.trim() : "";
  const dateEl = document.getElementById("customDate");
  const date = dateEl ? dateEl.value : "";

  if (!date) return alert("Por favor, elige una fecha.");

  try {
    let fileDataToSave = {};
    if (fileInput && fileInput.files.length > 0) {
      const file = fileInput.files[0];
      const fileData = await uploadToTransferSH(file);
      fileDataToSave = {
        fileName: fileData.fileName,
        fileURL: fileData.fileURL
      };
    }

    await addDoc(collection(db, "songs"), {
      video: url,
      chords,
      date,
      musicos: selectedMusicians,
      ...fileDataToSave
    });

    alert("✅ Canción agregada correctamente.");
    if (urlEl) urlEl.value = "";
    if (fileInput) fileInput.value = "";
    if (chordsEl) chordsEl.value = "";
    if (dateEl) dateEl.value = "";
    selectedMusicians = {};
    renderSongs();
  } catch (err) {
    console.error(err);
    alert("❌ Error: " + (err.message || "falló al guardar"));
  }
};

// --------- EDITAR CANCIÓN: USA uploadToTransferSH ---------
if (typeof saveEdit !== "undefined" && saveEdit) saveEdit.onclick = async () => {
  if (!currentEditId) return alert("No hay canción seleccionada.");
  try {
    const updates = {};
    const newVideo = editVideo && editVideo.value ? editVideo.value.trim() : "";
    const newChords = editChords && editChords.value ? editChords.value.trim() : "";
    const newDate = editDate && editDate.value ? editDate.value : "";

    if (newVideo) updates.video = newVideo;
    else if (currentEditSong && currentEditSong.video) updates.video = currentEditSong.video;

    if (newChords) updates.chords = newChords;
    else if (currentEditSong && currentEditSong.chords) updates.chords = currentEditSong.chords;

    if (newDate) updates.date = newDate;
    else if (currentEditSong && currentEditSong.date) updates.date = currentEditSong.date;

    // recoger músicos del modal
    const newMusicos = {};
    instruments.forEach(instr => {
      const sel = document.getElementById(`editsel-${instr.replace(/\s+/g,'_')}`);
      if (sel && sel.value) newMusicos[instr] = sel.value;
    });
    if (Object.keys(newMusicos).length > 0) updates.musicos = newMusicos;
    else if (currentEditSong && currentEditSong.musicos) updates.musicos = currentEditSong.musicos;

    // PDF nuevo con Transfer.sh
    if (editFile && editFile.files.length > 0) {
      const file = editFile.files[0];
      const fileData = await uploadToTransferSH(file);
      if (fileData.fileURL) updates.fileURL = fileData.fileURL;
      updates.fileName = file.name;
    } else {
      if (currentEditSong && currentEditSong.fileURL) {
        updates.fileURL = currentEditSong.fileURL;
        if (currentEditSong.fileName) updates.fileName = currentEditSong.fileName;
      }
    }

    await updateDoc(doc(db, "songs", currentEditId), updates);
    alert("✅ Cambios guardados.");
    if (editModal) editModal.style.display = "none";
    currentEditId = null;
    currentEditSong = null;
    renderSongs();
  } catch (err) {
    console.error(err);
    alert("❌ Error al guardar cambios: " + (err.message || err));
  }
};

// --------- RENDERIZADO PDF: preview móvil y enlace PC ---------
async function addSongToDOM(song, id) {
  // ...tu render igual hasta el PDF...
  const tdFile = document.createElement("td");
  tdFile.dataset.label = "Cifrado PDF";
  const fileUrl = song.fileURL || "";
  const isMobile = window.matchMedia && window.matchMedia("(max-width:520px)").matches;
  if (fileUrl) {
    if (isMobile) {
      // Google Docs Viewer en móvil
      const googleView = "https://docs.google.com/gview?url=" + encodeURIComponent(fileUrl) + "&embedded=true";
      tdFile.innerHTML = `
        <div style="display:flex;flex-direction:column;gap:6px;align-items:center;justify-content:center;">
          <a href="${fileUrl}" target="_blank" rel="noopener" style="display:inline-block;padding:8px 10px;background:#4A90E2;color:#fff;border-radius:8px;text-decoration:none;">Abrir PDF</a>
          <iframe src="${googleView}" style="width:100%;min-height:350px;border:none;margin-top:8px;"></iframe>
          <small style="font-size:0.82em;color:#666;text-align:center;">Si el visor no carga, pulsa "Abrir PDF". Si el enlace expira, contacta al admin.</small>
        </div>
      `;
    } else {
      tdFile.innerHTML = `<a href="${fileUrl}" target="_blank" rel="noopener">${song.fileName || 'PDF'}</a>`;
    }
  } else {
    tdFile.innerHTML = `<span style="color:#D9534F;">No hay PDF</span>`;
  }
  // ...resto igual...
}

/* El resto de tu script igual (sin tocar nada más) */
</script>
</body>
</html>