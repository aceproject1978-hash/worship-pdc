<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Calendario Worship PDC</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f9f9fb;color:#333;margin:15px}
h1{text-align:center;color:#4A90E2;font-weight:700;margin-bottom:10px;text-shadow:1px 1px 2px rgba(74,144,226,0.5)}
.hidden{display:none}
form,.calendar-block{width:100%;max-width:1100px;margin:0 auto 15px auto}
table{width:100%;border-collapse:collapse;margin-top:5px;table-layout:fixed}
table th:nth-child(1),table td:nth-child(1){width:18%}
table th:nth-child(2),table td:nth-child(2){width:28%}
table th:nth-child(3),table td:nth-child(3){width:12%}
table th:nth-child(4),table td:nth-child(4){width:25%}
table th:nth-child(5),table td:nth-child(5){width:10%}
table th:nth-child(6),table td:nth-child(6){width:7%}
th,td{border:1px solid #ccc;padding:5px 6px;text-align:center;vertical-align:middle;font-size:0.9em}
th{background:linear-gradient(135deg,#4A90E2,#357ABD);color:white;font-weight:600}
input[type=text],input[type=url],input[type=date],input[type=password],input[type=file]{width:95%;padding:4px 5px;border-radius:4px;border:1px solid #bbb;font-size:0.85em;box-sizing:border-box}
button{background-color:#4A90E2;border:none;color:white;padding:5px 10px;font-size:0.85em;font-weight:600;border-radius:5px;cursor:pointer;transition:background-color 0.3s ease}
button:hover{background-color:#357ABD}
.assign-green{background-color:#28a745;color:white;font-weight:600;padding:6px 12px;border:none;border-radius:5px;cursor:pointer;transition:background-color 0.3s ease;display:block;margin:5px auto}
.assign-green:hover{background-color:#218838}
iframe{max-width:180px;height:90px;display:block;margin:4px auto;border-radius:6px}
a{word-break:break-word;display:inline-block;font-size:0.8em;color:#274D87;text-decoration:none}
a:hover{text-decoration:underline}
.actions button{margin:2px 4px;font-size:0.75em;padding:3px 6px;border-radius:4px}
.actions .edit{background-color:#F0AD4E}
.actions .delete{background-color:#D9534F}
.calendar-block{border:2px solid #4A90E2;border-radius:8px;background:#fff;margin-bottom:15px;box-shadow:0 0 8px rgba(74,144,226,0.1);padding:0;overflow:hidden}
.calendar-date{background:#4A90E2;color:white;padding:5px;border-radius:8px 8px 0 0;font-weight:600;text-align:center;font-size:1em}
#logoutBtn{position:absolute;top:15px;right:25px}
#assignModal,#searchModal,#toneModal,#editModal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center;z-index:10010;padding:20px;box-sizing:border-box}
#assignContent,#searchContent,#toneContent,#editContent{background:#fff;padding:15px;border-radius:10px;box-shadow:0 0 15px rgba(0,0,0,0.25);box-sizing:border-box;z-index:10020}
#assignContent{width:280px}
#searchContent{width:500px;max-height:80vh;overflow-y:auto}
#toneContent{width:300px}
#editContent{width:420px;max-width:100%;max-height:85vh;display:flex;flex-direction:column;gap:8px;padding:12px 14px}
#assignContent h3,#searchContent h3,#toneContent h3,#editContent h3{color:#4A90E2;text-align:center;margin-bottom:8px}
.assign-item{margin:6px 0;display:flex;flex-direction:column}
.assign-item label{font-weight:bold;margin-bottom:3px}
.assign-item select{padding:4px;border:1px solid #ccc;border-radius:5px;font-size:0.85em}
td:nth-child(4){white-space:pre-line;text-align:left;font-size:0.9em}
.video-result{display:flex;align-items:center;gap:10px;border-bottom:1px solid #ccc;padding:8px}
.video-result iframe{width:120px;height:70px}
.video-result button{background:#28a745;padding:4px 8px;font-size:0.75em}
.tone-btn{margin-left:4px;padding:4px 7px;font-size:0.9em;border-radius:6px;background:#4A90E2;color:#fff;cursor:pointer;border:none}
.tone-option{display:inline-block;margin:6px 6px;padding:6px 10px;background:#f0f0f0;border-radius:5px;cursor:pointer}
.tone-option:hover{background:#4A90E2;color:#fff}
.edit-body{overflow:auto;padding-right:6px}
.edit-footer{display:flex;gap:10px;justify-content:center;align-items:center;padding-top:8px;border-top:1px solid #eee;margin-top:6px;background:transparent;flex-shrink:0}
.edit-footer button{min-width:120px}
#accessOverlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:9999;background:linear-gradient(180deg,rgba(0,0,0,0.7),rgba(0,0,0,0.85));backdrop-filter:blur(6px)}
.overlay-card{width:100%;max-width:540px;border-radius:14px;padding:28px;box-sizing:border-box;background:linear-gradient(180deg,rgba(10,10,12,0.6),rgba(6,6,8,0.45));border:1px solid rgba(255,255,255,0.06);box-shadow:0 12px 40px rgba(0,0,0,0.6);color:#fff;text-align:center;position:relative;overflow:hidden;backdrop-filter:blur(10px) saturate(1.05)}
.overlay-card .logo{width:220px;margin:0 auto 18px auto;display:block;filter:drop-shadow(0 8px 30px rgba(0,0,0,0.6))}
.overlay-card h2{margin:4px 0 14px 0;font-size:1.35rem;color:#ffd54a}
.choiceBtns{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin-bottom:16px}
.choiceBtns button{min-width:140px;padding:10px 14px;border-radius:10px;font-size:1rem;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.06);color:#fff;cursor:pointer}
.choiceBtns button:hover{background:rgba(255,255,255,0.12)}
.formBox{margin-top:8px;display:none;flex-direction:column;align-items:center;gap:8px}
.formBox input{width:90%;padding:10px;border-radius:8px;border:none;background:rgba(255,255,255,0.08);color:#fff;text-align:center;font-size:0.95rem}
.formBox .actions{display:flex;gap:8px;justify-content:center;width:90%}
.formBox .actions button{background:rgba(74,144,226,0.8);padding:8px 16px}
.formBox .actions button:hover{background:rgba(74,144,226,1)}
.smallMsg{margin-top:8px;color:#ffb3b3;font-weight:600;min-height:18px}
.closeOverlay{position:absolute;top:10px;right:12px;background:transparent;border:none;color:rgba(255,255,255,0.5);font-size:1.1rem;padding:6px;border-radius:8px;cursor:pointer}
.closeOverlay:hover{color:#fff;background:rgba(255,255,255,0.06)}
body.overlayLocked{overflow:hidden;height:100vh}
.table-container{width:100%;overflow:auto;-webkit-overflow-scrolling:touch}
.video-thumb{display:inline-block;width:160px;height:90px;border-radius:6px;overflow:hidden;background:#000}
.video-thumb img{width:100%;height:100%;object-fit:cover;display:block}
.file-uploaded{display:none;color:#28a745;font-weight:600;font-size:0.85em;padding:5px}
@media (max-width:520px){
  table{min-width:700px;table-layout:auto}
  th,td{padding:8px;border:1px solid #ddd;font-size:0.92em}
  .assign-green{width:100%;box-sizing:border-box}
  .overlay-card{padding:18px}
  body.overlayLocked h1{margin-top:48px}
}
@media (min-width:521px){
  .video-thumb{display:none!important}
}
</style>
<script>
  UPLOADCARE_PUBLIC_KEY = '86a133366056523562';
  UPLOADCARE_LOCALE = 'es';
</script>
<script src="https://ucarecdn.com/libs/widget/3.21.3/uploadcare.full.min.js"></script>
</head>
<body class="overlayLocked">
<h1>Calendario Worship PDC</h1>
<button id="logoutBtn" class="hidden">Cerrar sesión</button>

<div id="accessOverlay">
  <div class="overlay-card">
    <button class="closeOverlay" id="overlayClose">&times;</button>
    <img src="imagen1.jpg" alt="Logo PDC" class="logo">
    <h2>Bienvenido a Worship PDC</h2>
    <div class="choiceBtns" id="loginChoices">
      <button type="button" id="visitorChoice">Entrar como Visitante</button>
      <button type="button" id="adminChoice">Login Admin</button>
    </div>
    <div id="visitorBox" class="formBox">
      <input id="visitorPass" type="password" placeholder="Contraseña visitante">
      <div class="actions">
        <button type="button" id="visitorSubmit">Entrar</button>
        <button type="button" id="visitorCancel">Volver</button>
      </div>
    </div>
    <div id="adminBox" class="formBox">
      <input id="adminUser" type="text" placeholder="Usuario">
      <input id="adminPass" type="password" placeholder="Contraseña">
      <div class="actions">
        <button type="button" id="adminSubmit">Entrar</button>
        <button type="button" id="adminCancel">Volver</button>
      </div>
    </div>
    <div id="overlayError" class="smallMsg"></div>
  </div>
</div>

<div id="mainContent" class="hidden">
  <form id="lineForm" class="hidden">
    <div class="table-container">
      <table>
        <tr>
          <th>Video YouTube</th><th>Cifrado PDF</th><th>Tono</th><th>Músicos</th><th>Fecha</th><th>Acción</th>
        </tr>
        <tr>
          <td><div style="display:flex;align-items:center;gap:5px"><input type="url" id="videoURL" placeholder="https://..."><button type="button" id="searchVideoBtn">Buscar</button></div></td>
          <td>
            <button type="button" id="uploadBtn" style="width:95%;background:#28a745;padding:8px">📤 Subir PDF</button>
            <div id="fileUploaded" class="file-uploaded"></div>
          </td>
          <td><div style="display:flex;align-items:center;gap:5px;justify-content:center"><input type="text" id="chords" placeholder="G - D - Em"><button type="button" id="toneBtn" class="tone-btn">🎵</button></div></td>
          <td><button type="button" id="assignBtn" class="assign-green">Asignar músicos</button></td>
          <td><input type="date" id="customDate"></td>
          <td><button type="button" id="addLine">Agregar</button></td>
        </tr>
      </table>
    </div>
  </form>
  <h2 style="text-align:center;color:#4A90E2">Lista multimedia</h2>
  <div id="calendarContainer"></div>
</div>

<div id="toneModal"><div id="toneContent"><h3>Seleccionar Tono</h3><div id="toneOptions"></div><div style="text-align:center;margin-top:12px"><button type="button" id="closeTone">Cerrar</button></div></div></div>
<div id="assignModal"><div id="assignContent"><h3>Asignar Músicos</h3><div id="assignFields"></div><div style="text-align:center;margin-top:10px"><button type="button" id="saveAssign">Guardar</button><button type="button" id="closeAssign">Cerrar</button></div></div></div>
<div id="searchModal"><div id="searchContent"><h3>Buscar Video</h3><div id="videoList"></div><div style="text-align:center;margin-top:10px"><button type="button" id="closeSearch">Cerrar</button></div></div></div>
<div id="editModal"><div id="editContent"><h3>Modificar Canción</h3><div class="edit-body"><label>Video YouTube</label><input type="url" id="editVideo"><label>Cifrado PDF</label><button type="button" id="editUploadBtn" style="width:100%;background:#28a745;padding:8px;margin:5px 0">📤 Cambiar PDF</button><div id="editFileUploaded" class="file-uploaded"></div><label>Tono</label><input type="text" id="editChords"><div id="editAssignFields"></div><label>Fecha</label><input type="date" id="editDate"></div><div class="edit-footer"><button type="button" id="saveEdit">Guardar</button><button type="button" id="cancelEdit">Cancelar</button></div></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const app = initializeApp({
  apiKey: "AIzaSyDhWpUt9cfxa21T8ijfUCIJuApWBBaBUJQ",
  authDomain: "worship-pdc.firebaseapp.com",
  projectId: "worship-pdc",
  storageBucket: "worship-pdc.appspot.com",
  messagingSenderId: "132891019857",
  appId: "1:132891019857:web:3d72cfe959a8d14cdf4670"
});
const db = getFirestore(app);

const VISITOR_PASSWORD = "pdc2025*";
const ADMIN_USER = "ADMINPDC";
const ADMIN_PASS = "worship1039";

let loggedIn = false;
let visitorLogged = false;
let uploadedFileData = null;
let editUploadedFileData = null;

const accessOverlay = document.getElementById("accessOverlay");
const mainContent = document.getElementById("mainContent");
const lineForm = document.getElementById("lineForm");
const logoutBtn = document.getElementById("logoutBtn");

function extractYouTubeID(url) {
  if (!url) return null;
  const m = url.match(/(?:v=|youtu\.be\/|\/embed\/)([^&?/]+)/);
  return m ? m[1] : null;
}

function showOverlay() {
  accessOverlay.style.display = "flex";
  document.body.classList.add("overlayLocked");
  document.getElementById("overlayError").textContent = "";
  document.getElementById("visitorBox").style.display = "none";
  document.getElementById("adminBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
}

function hideOverlay() {
  accessOverlay.style.display = "none";
  document.body.classList.remove("overlayLocked");
}

function enterAsVisitor() {
  visitorLogged = true;
  loggedIn = false;
  hideOverlay();
  mainContent.classList.remove("hidden");
  lineForm.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
  renderSongs();
  localStorage.setItem("worship_role", "visitor");
}

function enterAsAdmin() {
  visitorLogged = false;
  loggedIn = true;
  hideOverlay();
  mainContent.classList.remove("hidden");
  lineForm.classList.remove("hidden");
  logoutBtn.classList.remove("hidden");
  renderSongs();
  localStorage.setItem("worship_role", "admin");
}

function restoreSession() {
  const role = localStorage.getItem("worship_role");
  if (role === "admin") enterAsAdmin();
  else if (role === "visitor") enterAsVisitor();
  else showOverlay();
}

document.getElementById("visitorChoice").onclick = () => {
  document.getElementById("loginChoices").style.display = "none";
  document.getElementById("visitorBox").style.display = "flex";
};

document.getElementById("adminChoice").onclick = () => {
  document.getElementById("loginChoices").style.display = "none";
  document.getElementById("adminBox").style.display = "flex";
};

document.getElementById("visitorCancel").onclick = () => {
  document.getElementById("visitorBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
};

document.getElementById("adminCancel").onclick = () => {
  document.getElementById("adminBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
};

document.getElementById("overlayClose").onclick = () => {
  document.getElementById("visitorBox").style.display = "none";
  document.getElementById("adminBox").style.display = "none";
  document.getElementById("loginChoices").style.display = "flex";
};

document.getElementById("visitorSubmit").onclick = () => {
  const pass = document.getElementById("visitorPass").value.trim();
  if (!pass) {
    document.getElementById("overlayError").textContent = "Ingresa la contraseña de visitante.";
    return;
  }
  if (pass === VISITOR_PASSWORD) enterAsVisitor();
  else document.getElementById("overlayError").textContent = "Contraseña incorrecta.";
};

document.getElementById("adminSubmit").onclick = () => {
  const user = document.getElementById("adminUser").value.trim();
  const pass = document.getElementById("adminPass").value.trim();
  if (!user || !pass) {
    document.getElementById("overlayError").textContent = "Ingresa usuario y contraseña.";
    return;
  }
  if (user === ADMIN_USER && pass === ADMIN_PASS) enterAsAdmin();
  else document.getElementById("overlayError").textContent = "Credenciales incorrectas.";
};

logoutBtn.onclick = () => {
  loggedIn = false;
  visitorLogged = false;
  localStorage.removeItem("worship_role");
  mainContent.classList.add("hidden");
  lineForm.classList.add("hidden");
  logoutBtn.classList.add("hidden");
  showOverlay();
};

restoreSession();

const instruments = ["BATERIA","PIANO","GUITARRA ACUSTICA","GUITARRA ELECTRICA","VOZ 1","VOZ 2","VOZ 3","VOZ LIDER","BAJO"];
const names = ["Rafael","Moises","Ronald","Nelson","Josue","Sebastian","Jose","Nayuris","Gabriela","Daniela","Carolina","Adriana"];
let selectedMusicians = {};

const assignBtn = document.getElementById("assignBtn");
const assignModal = document.getElementById("assignModal");
const assignFields = document.getElementById("assignFields");

function openAssignModal() {
  assignFields.innerHTML = "";
  instruments.forEach(instr => {
    const div = document.createElement("div");
    div.classList.add("assign-item");
    div.innerHTML = `<label>${instr}:</label>
      <select id="sel-${instr.replace(/\s+/g,'_')}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}" ${selectedMusicians[instr]===n?'selected':''}>${n}</option>`).join('')}
      </select>`;
    assignFields.appendChild(div);
  });
  assignModal.style.display = "flex";
}

assignBtn.onclick = () => {
  if (!loggedIn) return alert("Debes iniciar sesión");
  openAssignModal();
};

document.getElementById("closeAssign").onclick = () => {
  assignModal.style.display = "none";
};

document.getElementById("saveAssign").onclick = () => {
  instruments.forEach(instr=>{
    const sel = document.getElementById(`sel-${instr.replace(/\s+/g,'_')}`);
    if (sel) {
      const val = sel.value;
      if (val) selectedMusicians[instr] = val;
      else delete selectedMusicians[instr];
    }
  });
  assignModal.style.display = "none";
  alert("Asignaciones guardadas correctamente.");
};

const toneBtn = document.getElementById("toneBtn");
const toneModal = document.getElementById("toneModal");
const toneOptions = document.getElementById("toneOptions");
const chordsInput = document.getElementById("chords");
const baseNotes = ["C","C#","Db","D","D#","Eb","E","F","F#","Gb","G","G#","Ab","A","A#","Bb","B"];

function buildToneOptions() {
  toneOptions.innerHTML = "";
  baseNotes.forEach(n => {
    const maj = document.createElement("div");
    maj.className = "tone-option";
    maj.textContent = `${n} mayor`;
    maj.onclick = () => {
      chordsInput.value = maj.textContent;
      toneModal.style.display = "none";
    };
    toneOptions.appendChild(maj);
    
    const min = document.createElement("div");
    min.className = "tone-option";
    min.textContent = `${n} menor`;
    min.onclick = () => {
      chordsInput.value = min.textContent;
      toneModal.style.display = "none";
    };
    toneOptions.appendChild(min);
  });
}

toneBtn.onclick = () => {
  buildToneOptions();
  toneModal.style.display = "flex";
};

document.getElementById("closeTone").onclick = () => {
  toneModal.style.display = "none";
};

const searchVideoBtn = document.getElementById("searchVideoBtn");
const searchModal = document.getElementById("searchModal");
const videoList = document.getElementById("videoList");

searchVideoBtn.onclick = async () => {
  searchModal.style.display = "flex";
  videoList.innerHTML = "<p style='text-align:center;'>Cargando videos...</p>";
  try {
    const snap = await getDocs(collection(db, "songs"));
    videoList.innerHTML = "";
    snap.forEach(docSnap => {
      const song = docSnap.data();
      if (song.video) {
        const idv = extractYouTubeID(song.video);
        const iframeHtml = idv ? `<iframe src='https://www.youtube.com/embed/${idv}' frameborder='0'></iframe>` : "";
        const div = document.createElement("div");
        div.classList.add("video-result");
        div.innerHTML = `${iframeHtml}<div style="flex:1;"><p><strong>${song.date || ''}</strong></p><p style="word-break:break-all;">${song.video}</p></div>`;
        const selBtn = document.createElement("button");
        selBtn.type = "button";
        selBtn.textContent = "Seleccionar";
        selBtn.onclick = () => {
          document.getElementById("videoURL").value = song.video;
          searchModal.style.display = "none";
        };
        div.appendChild(selBtn);
        videoList.appendChild(div);
      }
    });
    if (videoList.children.length === 0) videoList.innerHTML = "<p style='text-align:center;color:#666;'>No hay videos guardados.</p>";
  } catch (err) {
    console.error(err);
    videoList.innerHTML = "<p style='text-align:center;color:#D9534F;'>Error cargando videos</p>";
  }
};

document.getElementById("closeSearch").onclick = () => {
  searchModal.style.display = "none";
};

const editModal = document.getElementById("editModal");
const editVideo = document.getElementById("editVideo");
const editChords = document.getElementById("editChords");
const editAssignFields = document.getElementById("editAssignFields");
const editDate = document.getElementById("editDate");

let currentEditId = null;
let currentEditSong = null;

function buildEditAssignFields(existingMusicos = {}) {
  editAssignFields.innerHTML = "<h4 style='text-align:center;margin:8px 0 6px 0;color:#4A90E2;'>Músicos</h4>";
  instruments.forEach(instr => {
    const div = document.createElement("div");
    div.classList.add("assign-item");
    const selId = `editsel-${instr.replace(/\s+/g,'_')}`;
    div.innerHTML = `<label style="font-weight:bold;margin-bottom:3px;">${instr}:</label>
      <select id="${selId}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}" ${existingMusicos[instr]===n?'selected':''}>${n}</option>`).join('')}
      </select>`;
    editAssignFields.appendChild(div);
  });
}

document.getElementById("cancelEdit").onclick = () => {
  editModal.style.display = "none";
  currentEditId = null;
  currentEditSong = null;
  editUploadedFileData = null;
  document.getElementById('editFileUploaded').style.display = 'none';
};

editModal.addEventListener('click', (e) => {
  if (e.target === editModal) {
    editModal.style.display = 'none';
    currentEditId = null;
    currentEditSong = null;
    editUploadedFileData = null;
    document.getElementById('editFileUploaded').style.display = 'none';
  }
});

window.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (editModal.style.display === 'flex') {
      editModal.style.display = 'none';
      currentEditId = null;
      currentEditSong = null;
      editUploadedFileData = null;
      document.getElementById('editFileUploaded').style.display = 'none';
    }
    if (assignModal.style.display === 'flex') assignModal.style.display = 'none';
    if (searchModal.style.display === 'flex') searchModal.style.display = 'none';
    if (toneModal.style.display === 'flex') toneModal.style.display = 'none';
  }
});

async function addSongToDOM(song, id) {
  let block = document.querySelector(`.calendar-block[data-date='${song.date}']`);
  if (!block) {
    block = document.createElement("div");
    block.classList.add("calendar-block");
    block.dataset.date = song.date;
    block.innerHTML = `<div class="calendar-date">${song.date}</div>
      <div class="table-container"><table><thead><tr><th>Video</th><th>Cifrado PDF</th><th>Tono</th><th>Músicos</th>${loggedIn?"<th>Acciones</th>":""}</tr></thead><tbody></tbody></table></div>`;
    document.getElementById("calendarContainer").appendChild(block);
  }

  const tbody = block.querySelector("tbody");
  const tr = document.createElement("tr");

  const tdVideo = document.createElement("td");
  if (song.video) {
    const vid = extractYouTubeID(song.video);
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile && vid) {
      const thumb = document.createElement('div');
      thumb.className = 'video-thumb';
      const link = document.createElement('a');
      link.href = `https://youtu.be/${vid}`;
      link.target = '_blank';
      link.rel = 'noopener';
      const img = document.createElement('img');
      img.src = `https://img.youtube.com/vi/${vid}/hqdefault.jpg`;
      img.alt = `Thumbnail`;
      link.appendChild(img);
      thumb.appendChild(link);
      tdVideo.appendChild(thumb);
    } else {
      tdVideo.innerHTML = vid ? `<iframe src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>` : "Link no válido";
    }
  }

  const tdFile = document.createElement("td");
  const fileURL = song.fileURL || "";
  console.log('🔍 PDF en render:', {fileURL, fileName: song.fileName});

  if (fileURL) {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    
    if (isMobile) {
      const btn = document.createElement('a');
      btn.href = fileURL;
      btn.download = song.fileName || 'cifrado.pdf';
      btn.target = '_blank';
      btn.rel = 'noopener noreferrer';
      btn.style.cssText = 'display:inline-block;padding:10px 16px;background:#28a745;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;font-size:0.9em;';
      btn.textContent = '📥 Descargar PDF';
      
      tdFile.style.textAlign = 'center';
      tdFile.appendChild(btn);
    } else {
      tdFile.innerHTML = `<a href="${fileURL}" target="_blank" rel="noopener">${song.fileName || 'Ver PDF'}</a>`;
    }
  } else {
    tdFile.textContent = "Sin PDF";
    tdFile.style.color = "#999";
  }

  const tdChords = document.createElement("td");
  tdChords.textContent = song.chords || "";

  const tdNote = document.createElement("td");
  tdNote.textContent = song.musicos ? Object.entries(song.musicos).map(([k,v])=>`${k}: ${v}`).join('\n') : "";

  tr.append(tdVideo, tdFile, tdChords, tdNote);

  if (loggedIn) {
    const tdActions = document.createElement("td");
    tdActions.classList.add("actions");

    const edit = document.createElement("button");
    edit.textContent = "Modificar";
    edit.classList.add("edit");
    edit.onclick = () => {
      currentEditId = id;
      currentEditSong = song;
      editVideo.value = song.video || "";
      editChords.value = song.chords || "";
      editDate.value = song.date || "";
      editUploadedFileData = null;
      document.getElementById('editFileUploaded').style.display = 'none';
      buildEditAssignFields(song.musicos || {});
      editModal.style.display = "flex";
    };

    const del = document.createElement("button");
    del.textContent = "Eliminar";
    del.classList.add("delete");
    del.onclick = async () => {
      if (confirm("¿Eliminar esta canción?")) {
        await deleteDoc(doc(db, "songs", id));
        renderSongs();
      }
    };

    tdActions.append(edit, del);
    tr.append(tdActions);
  }

  tbody.append(tr);
}

async function renderSongs() {
  const container = document.getElementById("calendarContainer");
  container.innerHTML = "";
  try {
    const querySnapshot = await getDocs(collection(db, "songs"));
    querySnapshot.forEach(docSnap => {
      const songData = docSnap.data();
      console.log('📋 Canción desde Firebase:', songData);
      addSongToDOM(songData, docSnap.id);
    });
  } catch (err) {
    console.error(err);
    container.innerHTML = "<p style='text-align:center;color:#D9534F;'>Error cargando canciones</p>";
  }
}

document.getElementById("saveEdit").onclick = async () => {
  if (!currentEditId) return alert("No hay canción seleccionada.");
  try {
    const updates = {};
    const newVideo = editVideo.value.trim();
    const newChords = editChords.value.trim();
    const newDate = editDate.value;

    if (newVideo) updates.video = newVideo;
    else if (currentEditSong?.video) updates.video = currentEditSong.video;

    if (newChords) updates.chords = newChords;
    else if (currentEditSong?.chords) updates.chords = currentEditSong.chords;

    if (newDate) updates.date = newDate;
    else if (currentEditSong?.date) updates.date = currentEditSong.date;

    const newMusicos = {};
    instruments.forEach(instr => {
      const sel = document.getElementById(`editsel-${instr.replace(/\s+/g,'_')}`);
      if (sel && sel.value) newMusicos[instr] = sel.value;
    });
    if (Object.keys(newMusicos).length > 0) updates.musicos = newMusicos;
    else if (currentEditSong?.musicos) updates.musicos = currentEditSong.musicos;

    if (editUploadedFileData) {
      updates.fileURL = editUploadedFileData.fileURL;
      updates.fileName = editUploadedFileData.fileName;
    } else {
      if (currentEditSong?.fileURL) {
        updates.fileURL = currentEditSong.fileURL;
        if (currentEditSong.fileName) updates.fileName = currentEditSong.fileName;
      }
    }

    await updateDoc(doc(db, "songs", currentEditId), updates);
    alert("✅ Cambios guardados.");
    editModal.style.display = "none";
    currentEditId = null;
    currentEditSong = null;
    editUploadedFileData = null;
    document.getElementById('editFileUploaded').style.display = 'none';
    renderSongs();
  } catch (err) {
    console.error(err);
    alert("❌ Error al guardar cambios: " + (err.message || err));
  }
};

document.getElementById("addLine").onclick = async () => {
  const url = document.getElementById("videoURL").value.trim();
  const chords = document.getElementById("chords").value.trim();
  const date = document.getElementById("customDate").value;

  if (!date) return alert("Por favor, elige una fecha.");

  console.log('4️⃣ uploadedFileData ANTES de guardar:', uploadedFileData);

  try {
    const songData = {
      video: url,
      chords,
      date,
      musicos: selectedMusicians
    };

    if (uploadedFileData) {
      songData.fileName = uploadedFileData.fileName;
      songData.fileURL = uploadedFileData.fileURL;
      console.log('5️⃣ ✅ PDF agregado a songData:', songData);
    } else {
      console.log('⚠️ No hay PDF para guardar');
    }

    console.log('6️⃣ songData COMPLETO:', songData);

    const docRef = await addDoc(collection(db, "songs"), songData);
    console.log('7️⃣ ✅ Guardado en Firebase con ID:', docRef.id);

    alert("✅ Canción agregada correctamente.");
    document.getElementById("videoURL").value = "";
    document.getElementById("chords").value = "";
    document.getElementById("customDate").value = "";
    selectedMusicians = {};
    uploadedFileData = null;
    document.getElementById('fileUploaded').style.display = 'none';
    
    console.log('8️⃣ Formulario limpiado');
    renderSongs();
  } catch (err) {
    console.error("❌ Error completo:", err);
    alert("❌ Error: " + (err.message || "falló al guardar"));
  }
};

document.getElementById("uploadBtn").onclick = () => {
  console.log('🔵 Abriendo widget de Uploadcare...');
  uploadcare.openDialog(null, {
    tabs: 'file',
    multiple: false,
    imagesOnly: false,
    inputAcceptTypes: '.pdf'
  }).done((file) => {
    console.log('1️⃣ Archivo seleccionado, procesando...', file);
    
    file.promise()
      .done((fileInfo) => {
        console.log('2️⃣ ✅ Archivo subido EXITOSAMENTE:', fileInfo);
        uploadedFileData = {
          fileName: fileInfo.name,
          fileURL: fileInfo.cdnUrl
        };
        console.log('3️⃣ uploadedFileData guardado:', uploadedFileData);
        document.getElementById('fileUploaded').textContent = '✅ ' + uploadedFileData.fileName;
        document.getElementById('fileUploaded').style.display = 'block';
      })
      .fail((error) => {
        console.error('❌ ERROR en file.promise():', error);
        alert('Error al subir el archivo a Uploadcare: ' + error);
        document.getElementById('fileUploaded').textContent = '❌ Error: ' + error;
        document.getElementById('fileUploaded').style.display = 'block';
        document.getElementById('fileUploaded').style.color = '#D9534F';
      })
      .progress((progress) => {
        console.log('📊 Progreso:', Math.round(progress.progress * 100) + '%');
        document.getElementById('fileUploaded').textContent = '⏳ Subiendo... ' + Math.round(progress.progress * 100) + '%';
        document.getElementById('fileUploaded').style.display = 'block';
        document.getElementById('fileUploaded').style.color = '#4A90E2';
      });
  }).fail((error) => {
    console.log('⚠️ Widget cerrado o error:', error);
  });
};

document.getElementById("editUploadBtn").onclick = () => {
  console.log('🔵 Abriendo widget para editar...');
  uploadcare.openDialog(null, {
    tabs: 'file',
    multiple: false,
    imagesOnly: false,
    inputAcceptTypes: '.pdf'
  }).done((file) => {
    console.log('📁 Archivo seleccionado para edición...');
    
    file.promise()
      .done((fileInfo) => {
        console.log('✅ Archivo de edición subido:', fileInfo);
        editUploadedFileData = {
          fileName: fileInfo.name,
          fileURL: fileInfo.cdnUrl
        };
        console.log('💾 editUploadedFileData guardado:', editUploadedFileData);
        document.getElementById('editFileUploaded').textContent = '✅ ' + editUploadedFileData.fileName;
        document.getElementById('editFileUploaded').style.display = 'block';
      })
      .fail((error) => {
        console.error('❌ ERROR en edición:', error);
        alert('Error al subir el archivo: ' + error);
        document.getElementById('editFileUploaded').textContent = '❌ Error: ' + error;
        document.getElementById('editFileUploaded').style.display = 'block';
        document.getElementById('editFileUploaded').style.color = '#D9534F';
      })
      .progress((progress) => {
        console.log('📊 Progreso edición:', Math.round(progress.progress * 100) + '%');
        document.getElementById('editFileUploaded').textContent = '⏳ Subiendo... ' + Math.round(progress.progress * 100) + '%';
        document.getElementById('editFileUploaded').style.display = 'block';
        document.getElementById('editFileUploaded').style.color = '#4A90E2';
      });
  });
};
</script>
</body>
</html>