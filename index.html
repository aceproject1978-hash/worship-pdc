<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Calendario Worship PDC</title>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f9f9fb;
  color: #333;
  margin: 15px;
}
h1 {
  text-align: center;
  color: #4A90E2;
  font-weight: 700;
  margin-bottom: 10px;
  text-shadow: 1px 1px 2px rgba(74,144,226,0.5);
  user-select: none;
}
.hidden { display: none; }

form, .calendar-block {
  width: 100%;
  max-width: 1100px;
  margin: 0 auto 15px auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 5px;
  table-layout: fixed;
}
table th:nth-child(1), table td:nth-child(1) { width: 18%; }
table th:nth-child(2), table td:nth-child(2) { width: 28%; }
table th:nth-child(3), table td:nth-child(3) { width: 12%; }
table th:nth-child(4), table td:nth-child(4) { width: 25%; }
table th:nth-child(5), table td:nth-child(5) { width: 10%; }
table th:nth-child(6), table td:nth-child(6) { width: 7%; }

th, td {
  border: 1px solid #ccc;
  padding: 5px 6px;
  text-align: center;
  vertical-align: middle;
  font-size: 0.9em;
}
th {
  background: linear-gradient(135deg, #4A90E2, #357ABD);
  color: white;
  font-weight: 600;
}

input[type=text], input[type=url], input[type=date], input[type=password], input[type=file] {
  width: 95%;
  padding: 4px 5px;
  border-radius: 4px;
  border: 1px solid #bbb;
  font-size: 0.85em;
  box-sizing: border-box;
}

button {
  background-color: #4A90E2;
  border: none;
  color: white;
  padding: 5px 10px;
  font-size: 0.85em;
  font-weight: 600;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}
button:hover { background-color: #357ABD; }

.assign-green {
  background-color: #28a745;
  color: white;
  font-weight: 600;
  padding: 6px 12px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  display: block;
  margin: 5px auto;
}
.assign-green:hover { background-color: #218838; }

iframe {
  max-width: 180px;
  height: 90px;
  display: block;
  margin: 4px auto;
  border-radius: 6px;
}

a {
  word-break: break-word;
  display: inline-block;
  font-size: 0.8em;
  color: #274D87;
  text-decoration: none;
}
a:hover { text-decoration: underline; }

.actions button {
  margin: 2px 4px;
  font-size: 0.75em;
  padding: 3px 6px;
  border-radius: 4px;
}
.actions .edit { background-color: #F0AD4E; }
.actions .delete { background-color: #D9534F; }

#loginSection {
  max-width: 360px;
  margin: 50px auto;
  padding: 20px;
  border-radius: 10px;
  background: rgba(255,255,255,0.95);
  box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  border: 1px solid rgba(74,144,226,0.3);
  text-align: center;
}
#loginSection img { width: 150px; margin-bottom: 10px; }
#loginSection h2 { margin-bottom: 10px; color: #4A90E2; }
#errorMsg { color: #D9534F; margin-bottom: 8px; }

.calendar-block {
  border: 2px solid #4A90E2;
  border-radius: 8px;
  background: #fff;
  margin-bottom: 15px;
  box-shadow: 0 0 8px rgba(74,144,226,0.1);
}
.calendar-date {
  background: #4A90E2;
  color: white;
  padding: 5px;
  border-radius: 8px 8px 0 0;
  font-weight: 600;
  text-align: center;
  font-size: 1em;
}
#loginBtn, #logoutBtn { position: absolute; top: 15px; right: 25px; }

#assignModal {
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}
#assignContent {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 0 15px rgba(0,0,0,0.25);
  width: 280px;
}
#assignContent h3 {
  color: #4A90E2;
  text-align: center;
  margin-bottom: 8px;
}
.assign-item { margin: 6px 0; display: flex; flex-direction: column; }
.assign-item label { font-weight: bold; margin-bottom: 3px; }
.assign-item select { padding: 4px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.85em; }
td:nth-child(4) { white-space: pre-line; text-align: left; font-size: 0.9em; }
</style>
</head>
<body>
<h1>Calendario Worship PDC</h1>
<button id="loginBtn">Login</button>
<button id="logoutBtn" class="hidden">Cerrar sesión</button>

<div id="loginSection" class="hidden">
  <img src="imagen1.jpg" alt="Logo PDC" />
  <h2>Inicio de Sesión</h2>
  <div id="errorMsg"></div>
  <input type="text" id="username" placeholder="Usuario" /><br><br>
  <input type="password" id="password" placeholder="Contraseña" /><br><br>
  <button id="confirmLogin">Ingresar</button>
  <button id="cancelLogin">Cancelar</button>
</div>

<div id="mainContent">
  <form id="lineForm" class="hidden">
    <table>
      <tr>
        <th>Video YouTube</th>
        <th>Cifrado PDF</th>
        <th>Tono</th>
        <th>Músicos</th>
        <th>Fecha</th>
        <th class="action-header">Acción</th>
      </tr>
      <tr>
        <td><input type="url" id="videoURL" placeholder="https://..."/></td>
        <td><input type="file" id="fileUpload" accept="application/pdf"/></td>
        <td><input type="text" id="chords" placeholder="Ej: G - D - Em"/></td>
        <td><button type="button" id="assignBtn" class="assign-green">Asignar músicos</button></td>
        <td><input type="date" id="customDate"/></td>
        <td class="action-cell"><button type="button" id="addLine">Agregar</button></td>
      </tr>
    </table>
  </form>

  <h2 style="text-align:center;color:#4A90E2;">Lista multimedia</h2>
  <div id="calendarContainer"></div>
</div>

<!-- Modal Asignar -->
<div id="assignModal">
  <div id="assignContent">
    <h3>Asignar Músicos</h3>
    <div id="assignFields"></div>
    <div style="text-align:center;margin-top:10px;">
      <button id="saveAssign">Guardar</button>
      <button id="closeAssign">Cerrar</button>
    </div>
  </div>
</div>

<!-- Firebase y lógica -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDhWpUt9cfxa21T8ijfUCIJuApWBBaBUJQ",
    authDomain: "worship-pdc.firebaseapp.com",
    projectId: "worship-pdc",
    storageBucket: "worship-pdc.appspot.com",
    messagingSenderId: "132891019857",
    appId: "1:132891019857:web:3d72cfe959a8d14cdf4670"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const USERNAME = "ADMINPDC";
  const PASSWORD = "worship1039";
  let loggedIn = localStorage.getItem("logueado") === "true";

  const instruments = ["BATERIA","PIANO","GUITARRA ACUSTICA","GUITARRA ELECTRICA","VOZ 1","VOZ 2","VOZ 3","VOZ LIDER","BAJO"];
  const names = ["Rafael","Moises","Ronald","Nelson","Josue","Jose","Sebastian","Nayuris","Gabriela","Daniela","Carolina","Adriana"];

  const assignBtn = document.getElementById("assignBtn");
  const assignModal = document.getElementById("assignModal");
  const assignFields = document.getElementById("assignFields");
  const saveAssign = document.getElementById("saveAssign");
  const closeAssign = document.getElementById("closeAssign");
  const calendarContainer = document.getElementById("calendarContainer");
  const lineForm = document.getElementById("lineForm");

  function openAssignModal(){
    assignFields.innerHTML="";
    instruments.forEach(instr=>{
      const div=document.createElement("div");
      div.classList.add("assign-item");
      div.innerHTML=`<label>${instr}:</label>
      <select id="sel-${instr.replace(/\s+/g,'_')}">
        <option value="">-- Seleccionar --</option>
        ${names.map(n=>`<option value="${n}">${n}</option>`).join('')}
      </select>`;
      assignFields.appendChild(div);
    });
    assignModal.style.display="flex";
  }

  assignBtn.onclick=()=>{if(loggedIn)openAssignModal();else alert("Debes iniciar sesión como ADMINPDC");};
  closeAssign.onclick=()=>assignModal.style.display="none";

  saveAssign.onclick=()=>{
    const selected={};
    instruments.forEach(instr=>{
      const sel=document.getElementById(`sel-${instr.replace(/\s+/g,'_')}`);
      selected[instr]=sel.value;
    });
    localStorage.setItem("asignaciones",JSON.stringify(selected));
    assignModal.style.display="none";
    alert("Asignaciones guardadas correctamente.");
  };

  function getAsignacionesTexto(){
    const asign=JSON.parse(localStorage.getItem("asignaciones")||"{}");
    return Object.entries(asign).filter(([i,n])=>n&&n.trim()!=="").map(([i,n])=>`${i}: ${n}`).join('\n');
  }

  function extractVideoID(url){
    const patterns=[/youtu\.be\/([^?&]+)/,/youtube\.com\/watch\?v=([^?&]+)/,/youtube\.com\/embed\/([^?&]+)/];
    for(const p of patterns){const m=url.match(p);if(m&&m[1])return m[1];}
    return null;
  }

  async function renderSongs(){
    calendarContainer.innerHTML="";
    const querySnapshot = await getDocs(collection(db, "songs"));
    querySnapshot.forEach(docSnap=>{
      const song=docSnap.data();
      song.id=docSnap.id;
      addSongToDOM(song,false);
    });
  }

  async function addSongToDOM(song,save=true){
    let block=document.querySelector(`.calendar-block[data-date='${song.date}']`);
    if(!block){
      block=document.createElement("div");
      block.classList.add("calendar-block");
      block.dataset.date=song.date;
      block.innerHTML=`<div class="calendar-date">${song.date}</div>
        <table><thead><tr><th>Video</th><th>Cifrado PDF</th><th>Tono</th><th>Músico</th>${loggedIn?"<th>Acciones</th>":""}</tr></thead><tbody></tbody></table>`;
      calendarContainer.appendChild(block);
    }
    const tbody=block.querySelector("tbody");
    const tr=document.createElement("tr");

    const tdVideo=document.createElement("td");
    if(song.video){
      const id=extractVideoID(song.video);
      tdVideo.innerHTML=id?`<iframe src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`:"Link no válido";
    }

    const tdFile=document.createElement("td");
    if(song.fileName) tdFile.innerHTML=`<a href="${song.fileURL}" target="_blank" download>${song.fileName}</a>`;

    const tdChords=document.createElement("td");
    tdChords.textContent=song.chords;

    const tdNote=document.createElement("td");
    tdNote.textContent=getAsignacionesTexto();

    tr.append(tdVideo,tdFile,tdChords,tdNote);

    if(loggedIn){
      const tdActions=document.createElement("td");
      tdActions.classList.add("actions");
      const del=document.createElement("button");
      del.textContent="Eliminar";
      del.classList.add("delete");
      del.onclick=async()=>{
        if(confirm("¿Eliminar esta canción?")){
          await deleteDoc(doc(db,"songs",song.id));
          renderSongs();
        }
      };
      tdActions.append(del);
      tr.append(tdActions);
    }

    tbody.append(tr);

    if(save){
      await addDoc(collection(db,"songs"),song);
      renderSongs();
    }
  }

  const loginBtn=document.getElementById("loginBtn");
  const logoutBtn=document.getElementById("logoutBtn");
  const loginSection=document.getElementById("loginSection");
  const confirmLogin=document.getElementById("confirmLogin");
  const cancelLogin=document.getElementById("cancelLogin");
  const errorMsg=document.getElementById("errorMsg");

  loginBtn.onclick=()=>{loginSection.classList.remove("hidden");loginBtn.classList.add("hidden");};
  cancelLogin.onclick=()=>{loginSection.classList.add("hidden");loginBtn.classList.remove("hidden");};
  confirmLogin.onclick=()=>{
    const user=document.getElementById("username").value.trim();
    const pass=document.getElementById("password").value.trim();
    if(user===USERNAME && pass===PASSWORD){
      loggedIn=true;
      localStorage.setItem("logueado","true");
      loginSection.classList.add("hidden");
      logoutBtn.classList.remove("hidden");
      lineForm.classList.remove("hidden");
      renderSongs();
    }else errorMsg.textContent="Usuario o contraseña incorrectos.";
  };
  logoutBtn.onclick=()=>{
    loggedIn=false;
    localStorage.setItem("logueado","false");
    logoutBtn.classList.add("hidden");
    loginBtn.classList.remove("hidden");
    lineForm.classList.add("hidden");
    renderSongs();
  };

  document.getElementById("addLine").onclick=async()=>{
    const url=document.getElementById("videoURL").value.trim();
    const fileInput=document.getElementById("fileUpload");
    const chords=document.getElementById("chords").value.trim();
    const date=document.getElementById("customDate").value;
    if(!date)return alert("Por favor, elige una fecha.");

    let fileData={};
    if(fileInput.files.length>0){
      const file=fileInput.files[0];
      const storageRef=ref(storage,"uploads/"+file.name);
      await uploadBytes(storageRef,file);
      const fileURL=await getDownloadURL(storageRef);
      fileData={fileName:file.name,fileURL};
    }

    const song={video:url,chords,date,...fileData};
    await addDoc(collection(db,"songs"),song);
    renderSongs();
  };

  renderSongs();
  if(loggedIn){logoutBtn.classList.remove("hidden");lineForm.classList.remove("hidden");}
  else loginBtn.classList.remove("hidden");
</script>
</body>
</html>
